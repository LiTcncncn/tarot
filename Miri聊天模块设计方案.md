# Miri 聊天模块设计方案

## 📋 模块概述

### 模块定位
将主导航的"疗愈"模块改为"Miri"，Miri 是应用中的 AI 陪伴角色——一朵云状精灵，用于与用户进行日常聊天和情感陪伴。

### 核心功能
- **AI 聊天对话**：用户可以与 Miri 进行自然对话
- **话题提示**：提供 3 个话语提示，帮助用户开启对话（每次对话后更新）
- **上下文记忆**：Miri 能够记住用户信息、状态、今日塔罗等信息，提供个性化对话
- **对话历史**：保存最近 20 组对答
- **镜像句欢迎（每日一问）**：每日首次进入时，以“聊天样式的一问一答一解析”展示（一个问题 + 3 个选项；选择后生成解析）

---

## 🎨 界面设计

### 整体布局

```
┌─────────────────────────────────┐
│        主题图区域                │
│   (20260113-222035.jpg)         │
│   云状精灵 Miri 主题图           │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│                                 │
│      聊天显示区                  │
│  ┌─────────────────────────┐   │
│  │ Miri: [镜像句问题]      │   │
│  │ [选项A] [选项B] [选项C] │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ 用户: 选择了选项A       │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ Miri: [针对选项的解读]  │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ 用户: 有点累...          │   │
│  └─────────────────────────┘   │
│  ┌─────────────────────────┐   │
│  │ Miri: 我理解...         │   │
│  └─────────────────────────┘   │
│                                 │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│   话语提示区（3个提示按钮）      │
│  [提示1] [提示2] [提示3]        │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│   用户输入区（单行）             │
│  [输入框]              [发送]    │
└─────────────────────────────────┘
```

### 详细设计

#### 1. 主题图区域
- **位置**：页面顶部
- **图片**：`20260113-222035.jpg`（云状精灵主题图）
- **尺寸**：全宽，高度自适应（建议高度：200-300px）
- **样式**：圆角、渐变遮罩（底部渐变透明，与聊天区自然过渡）

#### 2. 聊天显示区
- **位置**：主题图下方，占据主要空间
- **布局**：
  - 消息气泡样式（类似微信/iMessage）
  - Miri 消息：左侧，浅色背景，圆角气泡
  - 用户消息：右侧，主色调背景，圆角气泡
  - **镜像句消息**：特殊样式，显示问题和 3 个选项按钮
- **功能**：
  - 自动滚动到底部（新消息）
  - 支持长消息换行
  - 加载状态显示（Miri 思考中...）
  - **流式输出**：Miri 回复逐字显示（打字机效果）
- **初始消息**：进入页面时，显示镜像句问题（每日首次）

#### 3. 话语提示区
- **位置**：用户输入区上方
- **布局**：3 个横向排列的提示按钮
- **样式**：
  - 圆角按钮，浅色背景，边框
  - 文字居中，支持换行
  - 点击后高亮反馈
- **功能**：
  - 点击提示按钮，自动将提示文字填入输入框并发送
  - **每次对话后更新**：用户发送消息并收到回复后，重新生成 3 个话语提示
- **提示内容**：根据当前对话上下文和用户状态动态生成

#### 4. 用户输入区
- **位置**：页面底部（固定定位）
- **布局**：
  - 左侧：单行输入框
  - 右侧：发送按钮
- **功能**：
  - 支持回车发送
  - 输入框有占位符提示
  - 发送按钮在输入为空时禁用
  - 发送后清空输入框
  - **单行输入**：不支持换行（Enter 直接发送）

---

## 🔧 技术实现

### 1. 文件结构

```
demo/
├── index.html (修改导航项)
├── js/
│   ├── miri-chat.js (新建：Miri聊天核心逻辑)
│   └── main.js (修改：添加Miri页面路由)
└── css/
    └── miri-chat.css (新建：Miri聊天样式)
```

### 2. HTML 结构

```html
<!-- Miri 聊天页面 -->
<div id="miri-page" class="page" style="display: none;">
    <div class="miri-container">
        <!-- 主题图区域 -->
        <div class="miri-header-image">
            <img src="20260113-222035.jpg" alt="Miri" class="miri-theme-image">
        </div>
        
        <!-- 聊天显示区 -->
        <div class="miri-chat-area" id="miri-chat-area">
            <!-- 消息将通过 JS 动态添加 -->
        </div>
        
        <!-- 话语提示区 -->
        <div class="miri-suggestions" id="miri-suggestions">
            <button class="suggestion-btn" data-suggestion="0">提示1</button>
            <button class="suggestion-btn" data-suggestion="1">提示2</button>
            <button class="suggestion-btn" data-suggestion="2">提示3</button>
        </div>
        
        <!-- 用户输入区 -->
        <div class="miri-input-area">
            <input 
                type="text"
                id="miri-input" 
                class="miri-input-text" 
                placeholder="和 Miri 说点什么..."
            />
            <button id="miri-send-btn" class="miri-send-btn">发送</button>
        </div>
    </div>
</div>
```

### 3. JavaScript 核心逻辑

#### 3.1 消息管理
- **消息数据结构**：
```javascript
{
    id: timestamp,
    role: 'user' | 'miri',
    content: string,
    timestamp: Date
}
```

- **消息渲染**：根据 role 渲染不同样式的气泡
- **对话历史存储**：
  - 使用 localStorage 存储对话历史
  - **保存最近 20 组对答**（仅“用户 ↔ Miri”对话计数）
  - **超过 20 组时，删除最旧的组**
  - 镜像句不写入对话历史（不占 20 组对答配额），但会在聊天区顶部以聊天样式展示（见 3.4）
  - 用户刷新页面后，镜像句的“选择与解析”仍可恢复展示（镜像句有独立存储）

#### 3.2 API 调用
- **使用统一的 LLM API**：复用 `api.js` 中的 API 配置
- **Prompt 构建**：构建包含用户上下文信息的 Prompt
- **流式响应**：
  - 实现流式输出，逐字显示回复（打字机效果）
  - **流式输出速度**：30-50ms 每字
  - **流式输出过程中，用户不可以中断**
  - 网络较慢时，暂时不需要特殊优化

#### 3.3 上下文记忆
**记忆范围：仅"今日"信息**

记忆内容包括：
- **用户信息**：姓名、生日、星座等（从 `getUserProfile()` 获取）
- **用户状态**：当前情绪状态（从 `getTodayReading()` 获取）
- **今日塔罗**：今日抽到的牌、解读内容（从 `getTodayReading()` 获取）
- **今日生成信息**：今日的所有指引、幸运元素、今日分析等

**不包括历史信息**（之前的每日占卜、历史对话等）

补充：**镜像句记忆（用于对话上下文）**
- 镜像句不作为 `miri_chat_history` 的消息保存，但会以“镜像句记忆”拼接进 prompt 上下文（用于 Miri 回答时理解用户当日/历史镜像句选择）
- 规则：
  - **今天**：镜像句会进入上下文（未选择则仅记录“一问”；已选择则记录“一问一答一解析”）
  - **今天以前**：只有当用户**选过选项（至少有一答）**时才进入上下文；若“未选择”，则不进入上下文，且会被清理（见 3.4）

#### 3.4 镜像句欢迎消息

**功能说明**：
- 每日首次进入 Miri 页面时，显示镜像句问题
- 镜像句形式：一个问题 + 3 个选项
- 用户点击选项后，生成针对该选项的解读
- 以此作为每天的初始话题

**实现逻辑（当前实现）**：
1. **每日占卜生成时预生成镜像句**：每日占卜 API 完成后，会额外生成 `mirrorQuestion` 并保存到今日占卜的 `reading.mirrorQuestion`
2. 进入 Miri 页面时：
   - 优先读取今日占卜的 `reading.mirrorQuestion`
   - 将其写入镜像句独立存储（见下）
   - 在聊天区顶部以“聊天样式”展示“一问”（带 3 个选项按钮）
3. 用户选择后：
   - 在聊天区继续显示“一答”（用户选项气泡）
   - 调用 API 生成“一解析”（Miri 解析气泡，支持流式输出）
   - 将选择与解析写入镜像句独立存储，刷新后仍可恢复展示
4. **清理规则**：今天以前且未选择（用户未回应）的镜像句会被自动删除，不再展示、不进入记忆

**镜像句独立存储（localStorage）**：
- Key：`miri_daily_mirror_YYYY-MM-DD`
- Value：
```json
{
  "question": "…",
  "options": ["…","…","…"],
  "selectedOption": "… | null",
  "interpretation": "… | null"
}
```

**镜像句生成 Prompt**：
```
基于以下今日信息，生成一个镜像句问题：

【今日塔罗信息】
塔罗牌：{cardName} ({cardNameCn})
今日指引：{guidance}
今日分析：{todayAnalysis}
月相：{moonPhase}

【用户当前状态】
情绪状态：{emotion}

请生成一个镜像句问题，格式为：
- 一个问题（15-25字）
- 3个选项（每个选项10-15字）

镜像句应该：
- 帮助用户进行自我觉察
- 与今日塔罗和用户状态相关
- 能够引发有意义的思考

返回 JSON 格式：
{
  "question": "问题文本",
  "options": [
    "选项A",
    "选项B",
    "选项C"
  ]
}
```

**镜像句解读 Prompt**：
```
用户选择了镜像句的选项："{selectedOption}"

【镜像句问题】
问题：{question}
选项：{options}
用户选择：{selectedOption}

【今日信息】
（同上）

请生成针对用户选择的解读（150-200字），帮助用户理解自己的选择。
```

#### 3.5 话语提示生成
- **生成逻辑**：根据当前对话上下文和用户状态，AI 生成 3 个相关话题提示
- **更新时机**：
  - 页面首次加载时生成（在镜像句交互完成后）
  - **每次对话后更新**：用户发送消息并收到回复后，重新生成 3 个话语提示
- **更新方式**：
  - **不需要动画效果**：直接更新提示内容
  - **不需要显示加载状态**：异步更新，不阻塞用户输入
  - **API 调用失败时，保持原有内容**：不更新提示
- **Prompt**：基于当前对话历史和用户状态生成提示

---

## 💬 Prompt 设计

### 系统 Prompt

```
你是 Miri，一朵可爱、治愈的云状精灵，是用户的 AI 陪伴伙伴。

你的性格特点：
- 温柔、友善、充满同理心
- 说话风格轻松、自然，像朋友一样
- 能够理解用户的情绪，给予温暖的支持
- 结合塔罗、月相等信息，提供有意义的对话

你的对话原则：
1. 始终以温暖、鼓励的语气与用户交流
2. 结合用户的状态和今日信息，提供个性化回应
3. 不要过于正式或说教，保持轻松友好的氛围
4. 在用户情绪低落时，给予更多安慰和支持
5. 可以主动询问用户的感受，但不要过于频繁

请用中文回复，保持简洁自然。
```

### 用户 Prompt 模板（日常对话）

```
【用户信息】
姓名：{userName}（如有）
星座：{zodiac}（如有）
生日：{birthday}（如有）

【用户当前状态】
情绪状态：{emotion}（愉悦/平静/疲惫/迷茫/焦虑）

【今日塔罗信息】
塔罗牌：{cardName} ({cardNameCn})
牌面含义：{cardMeaning}
今日指引：{guidance}
今日分析：{todayAnalysis}
月相：{moonPhase}
幸运元素：{luckyElements}

【今日生成的其他信息】
简洁指引：{conciseGuidance}
单行指引：{guidanceOneLine}
疗愈任务：{healingTask}
领域指引：{categoryGuidances}

【对话历史】（最近20组对答，最多40条消息）
{conversationHistory}

【用户当前消息】
{userMessage}

请基于以上信息，以 Miri 的身份回复用户。
```

### 话语提示生成 Prompt

```
基于以下信息，生成 3 个适合开启对话的话题提示：

【用户信息】（同上）

【当前对话历史】
{conversationHistory}

请生成 3 个简短、自然的话题提示（每个 10-15 字），帮助用户与 Miri 继续对话。
话题应该：
- 与当前对话上下文相关
- 与用户当前状态相关
- 与今日塔罗信息相关
- 自然、不突兀
- 能够引发有意义的对话

返回 JSON 格式：
{
  "suggestions": [
    "提示1",
    "提示2", 
    "提示3"
  ]
}
```

---

## 📱 交互流程

### 1. 页面加载流程
```
用户点击导航"Miri"
  ↓
显示 Miri 页面
  ↓
加载主题图
  ↓
检查今日是否已显示镜像句
  ↓
如果未显示：
  - 调用 API 生成镜像句问题
  - 显示镜像句消息（问题 + 3个选项）
  - 等待用户选择选项
如果已显示：
  - 加载对话历史（如果有）
  - 生成话语提示
  ↓
等待用户输入
```

### 2. 镜像句交互流程
```
显示镜像句问题（问题 + 3个选项）
  ↓
用户点击某个选项
  ↓
显示用户选择的消息
  ↓
显示"Miri 正在思考..."加载状态
  ↓
调用 API 生成针对选项的解读
  ↓
流式输出解读内容（逐字显示）
  ↓
标记今日已显示镜像句
  ↓
生成话语提示
```

### 3. 发送消息流程
```
用户输入消息（或点击提示）
  ↓
显示用户消息气泡
  ↓
显示"Miri 正在思考..."加载状态
  ↓
构建 Prompt（包含上下文信息和对话历史）
  ↓
调用 LLM API（流式请求）
  ↓
流式接收回复，逐字显示（打字机效果）
  ↓
保存消息到对话历史（限制20组对答）
  ↓
更新话语提示（重新生成3个提示）
```

### 4. 话语提示点击流程
```
用户点击提示按钮
  ↓
将提示文字填入输入框
  ↓
自动发送消息
  ↓
（后续流程同"发送消息流程"）
```

### 5. 错误处理流程
```
API 调用失败
  ↓
显示错误消息："你的话让我有些混乱，让我想一想……"
  ↓
允许用户重试（重新发送或修改消息）
```

---

## 🎯 功能细节

### 1. 消息显示
- **时间戳**：每条消息显示时间（可选，简化版可不显示）
- **头像**：Miri 消息显示小头像（云状图标）
- **动画**：消息出现时的淡入动画
- **滚动**：新消息自动滚动到底部
- **流式输出**：Miri 回复逐字显示（打字机效果）

### 2. 加载状态
- **思考动画**：Miri 思考时显示"..."动画或加载图标
- **错误处理**：
  - API 调用失败时显示："你的话让我有些混乱，让我想一想……"
  - **显示错误消息后，自动重试**（重新调用 API）
  - 网络断开时：直接提示"网络断开，请检查网络连接"
  - API 调用超时时：显示"你的话让我有些混乱，让我想一想……"（同 API 调用失败）

### 3. 输入体验
- **自动聚焦**：
  - 进入页面时自动聚焦输入框（镜像句交互完成后）
  - 发送消息后重新聚焦输入框（保持输入连续性）
- **回车发送**：Enter 键发送消息
- **输入限制**：限制最大字符数（如 200 字）
- **发送防抖**：防止快速重复发送
- **单行输入**：
  - 输入框为单行，不支持换行
  - 内容较长时，输入框支持横向滚动（不缩小字体）

### 4. 对话历史管理
- **存储方式**：localStorage
- **存储格式**：JSON 数组，每条消息包含 role、content、timestamp
- **存储限制**：保存最近 20 组对答（40 条消息）
- **清理机制**：超过 20 组时，删除最旧的消息

### 5. 镜像句管理
- **显示标记**：使用 localStorage 记录每日是否已显示镜像句
- **标记格式**：`miri_mirror_shown_YYYY-MM-DD`
- **重置机制**：每日 00:00 重置标记
- **存储方式**：
  - 镜像句内容不写入 `miri_chat_history`
  - 镜像句以独立 Key 存储：`miri_daily_mirror_YYYY-MM-DD`
  - 用户刷新页面后，镜像句的“选择与解析”仍可恢复展示
  - 今天以前且未选择的镜像句会被自动清理，不再展示、不进入记忆
- **样式**：镜像句的 3 个选项使用简单样式，不需要不同颜色区分

### 6. 响应式设计
- **移动端**：全屏聊天界面
- **PC 端**：居中显示，最大宽度限制

### 7. 性能优化
- **当前阶段**：暂不需要性能优化
- **未来考虑**：
  - 对话历史压缩（如果需要）
  - 流式输出性能优化（如果需要）
  - 消息缓存（如果需要）

---

## 🔄 与现有系统集成

### 1. 导航栏修改
- 将 `data-nav="healing"` 改为 `data-nav="miri"`
- 图标改为云状图标（☁️ 或自定义图标）
- 标签改为 "Miri"

### 2. 路由处理
- 在 `main.js` 中添加 `case 'miri':` 处理
- 调用 `showMiriPage()` 函数

### 3. 数据获取
- 复用现有的 `getUserProfile()`、`getTodayReading()` 等函数
- 从 `storage.js` 获取用户数据
- **仅获取今日信息**，不包括历史数据

### 4. API 调用
- 复用 `api.js` 中的 API 配置
- 创建新的函数：
  - `generateMirrorQuestion()` - 生成镜像句问题
  - `generateMirrorInterpretation()` - 生成镜像句解读
  - `generateMiriResponse()` - 生成 Miri 回复（流式）
  - `generateMiriSuggestions()` - 生成话语提示

### 5. 流式输出实现
- 使用 Server-Sent Events (SSE) 或流式 API
- 逐字接收并显示回复
- 实现打字机效果（逐字显示动画）

---

## ✅ 已确认的设计决策

### 1. 镜像句相关
- ✅ **镜像句以“聊天样式的一问一答一解析”展示**（在聊天区顶部）
- ✅ **镜像句不写入 `miri_chat_history`**（不占 20 组对答配额），但会进入 prompt 的“镜像句记忆”
- ✅ **今天以前且未选择的镜像句不保留**（会被清理）
- ✅ **用户刷新页面后，镜像句的“选择与解析”仍可恢复展示**
- ✅ **镜像句的 3 个选项使用简单样式**（不需要不同颜色区分）

### 2. 对话历史管理
- ✅ **对话历史保存最近 20 组对答**
- ✅ **对话历史超出 20 组时，删除最旧的组**
- ✅ **镜像句不计入 20 组对答**（仅用户↔Miri对话计数）

### 3. 流式输出
- ✅ **流式输出速度**：30-50ms 每字
- ✅ **网络较慢时，暂时不需要特殊优化**
- ✅ **流式输出过程中，用户不可以中断**

### 4. 话语提示更新
- ✅ **话语提示更新时，不需要动画效果**
- ✅ **API 调用失败时，话语提示保持原有内容**
- ✅ **话语提示更新不需要显示加载状态**（异步更新，不阻塞用户输入）

### 5. 错误处理
- ✅ **显示错误消息"你的话让我有些混乱，让我想一想……"后，自动重试**
- ✅ **网络断开时，直接提示"网络断开，请检查网络连接"**
- ✅ **API 调用超时时，显示"你的话让我有些混乱，让我想一想……"（同 API 调用失败）**

### 6. 用户体验（已确定）
- ✅ **输入框自动聚焦**：进入页面时聚焦，发送消息后重新聚焦
- ✅ **单行输入框内容较长时，支持横向滚动**（不缩小字体）
- ✅ **镜像句选项按钮使用简单样式**，与普通消息气泡有区分但保持简洁

### 7. 性能优化
- ✅ **当前阶段暂不需要性能优化**

---

## 📝 开发优先级

### Phase 1: 核心功能（MVP）
- [ ] 页面基础布局（主题图 + 聊天区 + 输入区）
- [ ] 单行输入框和发送功能
- [ ] 消息发送和显示（基础版本，非流式）
- [ ] API 调用和回复显示
- [ ] 基础上下文记忆（用户信息 + 今日塔罗）
- [ ] 导航栏修改（healing → miri）

### Phase 2: 核心交互
- [ ] 镜像句功能（问题生成 + 选项交互 + 解读生成）
- [ ] 镜像句显示标记（每日首次显示）
- [ ] 对话历史保存（localStorage，20组对答）
- [ ] 话语提示功能（3个提示按钮）
- [ ] 话语提示动态更新（每次对话后）

### Phase 3: 增强体验
- [ ] 流式输出（逐字显示，打字机效果）
- [ ] 加载状态和错误处理
- [ ] 消息动画效果
- [ ] 响应式优化

### Phase 4: 优化功能
- [ ] 性能优化
- [ ] 错误重试机制
- [ ] 对话历史管理优化

---

## 🎨 设计参考

### 主题图
- 文件：`20260113-222035.jpg`
- 描述：云状精灵在魔法森林中，柔和的光线，治愈的氛围
- 使用：作为页面顶部主题图，营造 Miri 的陪伴氛围

### 视觉风格
- **色彩**：柔和、治愈的森林色系（浅绿色为主），与主题图的森林氛围一致
- **圆角**：所有元素使用圆角设计，保持友好感
- **间距**：充足的留白，保持轻松感
- **字体**：清晰易读，支持中文显示

---

## 📚 相关文件

- `demo/index.html` - 需要添加 Miri 页面 HTML
- `demo/js/main.js` - 需要添加 Miri 页面路由
- `demo/js/api.js` - 需要添加 Miri API 调用函数（包括流式输出）
- `demo/js/storage.js` - 用于获取用户数据和今日信息
- `demo/css/style.css` - 需要添加 Miri 页面样式（或新建 `miri-chat.css`）
- `产品设计.md` - 镜像句相关设计参考

---

## 🔄 后续扩展

### 未来可能的功能
1. **语音输入**：支持语音转文字输入
2. **语音回复**：Miri 的回复支持语音播放（TTS）
3. **表情系统**：Miri 根据对话内容显示不同表情
4. **亲密度系统**：根据对话频率和深度，提升与 Miri 的亲密度
5. **个性化定制**：用户可以自定义 Miri 的外观或性格

---

## 📋 确认清单

### 核心功能点（全部已确认）
- ✅ **名称**：Miri（原 miru）
- ✅ **话语提示更新策略**：每次对话后更新
- ✅ **对话历史保存**：保存 20 组对答（超出时删除最旧的）
- ✅ **记忆范围**：仅"今日"信息
- ✅ **欢迎消息**：镜像句形式（一个问题 + 3 个选项）
- ✅ **输入方式**：单行（内容较长时横向滚动）
- ✅ **流式输出**：需要逐字显示（30-50ms 每字，不可中断）
- ✅ **错误处理**：API 失败/超时显示"你的话让我有些混乱，让我想一想……"并自动重试；网络断开直接提示

### 设计细节（全部已确认）
- ✅ **镜像句存储**：镜像句独立存储（`miri_daily_mirror_YYYY-MM-DD`），不写入 `miri_chat_history`；今天以前未选择会清理
- ✅ **镜像句样式**：3 个选项使用简单样式，不需要不同颜色区分
- ✅ **话语提示更新**：无动画、无加载状态、失败时保持原内容
- ✅ **输入体验**：自动聚焦、发送后重新聚焦、横向滚动
- ✅ **性能优化**：当前阶段暂不需要

### 设计状态
✅ **所有功能点和设计细节已确认，可以开始实现！**

---

**请查看以上新问题，确认后我们可以开始实现！**
