# 幸运元素规则设计方案

## 一、总体设计

### 1.1 元素定义
- **保留**：幸运数字、幸运颜色
- **新增**：幸运植物、幸运石
- **移除**：幸运饰品、幸运摆件

### 1.2 实现方式
- **不再通过 LLM 生成**
- **基于规则表匹配**
- **多维度优先级匹配**：星盘 > 星座 > 月相 > 塔罗 > 降级默认

### 1.3 降级匹配策略
用户未填写星盘/星座信息时，自动降级到月相+塔罗匹配，用户无感知

---

## 二、匹配规则设计

### 2.1 匹配优先级

```
Level 1: 星盘（完整出生信息：日期+时间+地点）
  └─> 匹配：星盘+月相+塔罗

Level 2: 星座（仅出生日期）
  └─> 匹配：星座+月相+塔罗

Level 3: 月相+塔罗（无用户星座信息）
  └─> 匹配：月相+塔罗

Level 4: 仅塔罗（极端情况，不应发生）
  └─> 匹配：塔罗牌
```

### 2.2 匹配维度说明

#### A. 星盘维度（最高优先级）
- **前提**：用户填写了完整出生信息（日期+时间+地点）
- **依据**：传统占星学中，星盘上升星座、太阳星座、月亮星座、行星位置等
- **实现**：可计算太阳星座、月亮星座、上升星座（如有星盘API）
- **现状**：系统目前无星盘计算能力，先预留接口，Level 1 降级到 Level 2

#### B. 星座维度
- **前提**：用户填写了出生日期（已有 `getZodiacFromDate` 函数）
- **依据**：传统占星学中，12星座与颜色、数字、宝石、植物的对应关系
- **匹配规则**：直接匹配用户星座对应的幸运元素

#### C. 月相维度
- **前提**：系统已计算今日月相
- **依据**：传统占星学中，8种月相的能量特性与元素对应
- **匹配规则**：根据月相类型匹配对应的幸运元素

#### D. 塔罗维度
- **前提**：今日抽取的塔罗牌（已有牌数据）
- **依据**：传统塔罗学中，78张牌与星座、元素、数字的对应关系
- **匹配规则**：
  - 大阿卡纳（0-21）：直接对应星座/元素
  - 小阿卡纳：根据花色（圣杯/宝剑/权杖/星币）对应元素

---

## 三、对应关系表设计

### 3.1 塔罗牌与星座/元素对应表

#### 大阿卡纳（22张）与星座对应

| 塔罗牌ID | 牌名 | 对应星座 | 对应元素 | 依据 |
|---------|------|---------|---------|------|
| 0 | 愚者 | 风元素/天王星 | 风 | 传统塔罗对应 |
| 1 | 魔术师 | 水星 | 风 | 水星主沟通，对应风元素 |
| 2 | 女祭司 | 月亮 | 水 | 月亮对应水元素 |
| 3 | 皇后 | 金星/金牛座 | 土 | 金星主爱与美 |
| 4 | 皇帝 | 白羊座/火星 | 火 | 白羊座对应 |
| 5 | 教皇 | 金牛座 | 土 | 传统对应 |
| 6 | 恋人 | 双子座 | 风 | 双子座对应 |
| 7 | 战车 | 巨蟹座 | 水 | 巨蟹座对应 |
| 8 | 力量 | 狮子座 | 火 | 狮子座对应 |
| 9 | 隐者 | 处女座 | 土 | 处女座对应 |
| 10 | 命运之轮 | 木星 | - | 木星，使用月相补充 |
| 11 | 正义 | 天秤座 | 风 | 天秤座对应 |
| 12 | 倒吊人 | 海王星/水元素 | 水 | 传统对应 |
| 13 | 死神 | 天蝎座 | 水 | 天蝎座对应 |
| 14 | 节制 | 射手座 | 火 | 射手座对应 |
| 15 | 恶魔 | 摩羯座 | 土 | 摩羯座对应 |
| 16 | 高塔 | 火星/火元素 | 火 | 火星对应 |
| 17 | 星星 | 水瓶座 | 风 | 水瓶座对应 |
| 18 | 月亮 | 双鱼座 | 水 | 双鱼座对应 |
| 19 | 太阳 | 太阳/狮子座 | 火 | 太阳对应 |
| 20 | 审判 | 火元素/冥王星 | 火 | 传统对应 |
| 21 | 世界 | 土星 | 土 | 土星对应 |

#### 小阿卡纳花色与元素对应

| 花色 | 元素 | 依据 |
|------|------|------|
| 圣杯 (Cups) | 水 | 传统塔罗四元素 |
| 宝剑 (Swords) | 风 | 传统塔罗四元素 |
| 权杖 (Wands) | 火 | 传统塔罗四元素 |
| 星币 (Pentacles) | 土 | 传统塔罗四元素 |

#### 小阿卡纳数字提取规则
- Ace-10：直接使用数字（1-10）
- 宫廷牌（Page/Knight/Queen/King）：根据花色元素匹配，数字使用 11/12/13/14

### 3.2 星座与幸运元素对应表

| 星座 | 元素 | 幸运数字 | 幸运颜色 | 幸运植物 | 幸运石 | 依据 |
|------|------|---------|---------|---------|--------|------|
| 白羊座 | 火 | 9 | 红色、橙红色 | 薄荷、百里香 | 红宝石、石榴石 | 传统占星学 |
| 金牛座 | 土 | 6 | 绿色、粉色 | 玫瑰、紫罗兰 | 祖母绿、粉水晶 | 传统占星学 |
| 双子座 | 风 | 5 | 黄色、亮橙色 | 薰衣草、雏菊 | 黄水晶、玛瑙 | 传统占星学 |
| 巨蟹座 | 水 | 7 | 银色、白色 | 睡莲、茉莉 | 珍珠、月光石 | 传统占星学 |
| 狮子座 | 火 | 19 | 金色、橙色 | 向日葵、金盏花 | 琥珀、黄玉 | 传统占星学 |
| 处女座 | 土 | 9 | 米色、深蓝色 | 薰衣草、鼠尾草 | 蓝宝石、玛瑙 | 传统占星学 |
| 天秤座 | 风 | 6 | 淡蓝色、粉色 | 玫瑰、天竺葵 | 蓝宝石、粉水晶 | 传统占星学 |
| 天蝎座 | 水 | 13 | 深红色、黑色 | 仙人掌、菊花 | 黑曜石、红宝石 | 传统占星学 |
| 射手座 | 火 | 3 | 紫色、深蓝色 | 鼠尾草、蒲公英 | 绿松石、紫水晶 | 传统占星学 |
| 摩羯座 | 土 | 10 | 棕色、深绿色 | 常春藤、松树 | 黑玛瑙、蓝宝石 | 传统占星学 |
| 水瓶座 | 风 | 11 | 天蓝色、银色 | 紫罗兰、兰花 | 紫水晶、海蓝宝 | 传统占星学 |
| 双鱼座 | 水 | 12 | 海绿色、紫色 | 莲花、水仙 | 海蓝宝、紫水晶 | 传统占星学 |

### 3.3 月相与幸运元素对应表

| 月相 | 能量特性 | 幸运数字 | 幸运颜色 | 幸运植物 | 幸运石 | 依据 |
|------|---------|---------|---------|---------|--------|------|
| 新月 | 新开始、设定意图 | 1 | 黑色、深蓝色 | 茉莉、栀子花 | 黑曜石、月光石 | 新月能量 |
| 上弦月渐盈 | 成长、采取行动 | 3 | 银色、浅蓝色 | 薰衣草、薄荷 | 月光石、白水晶 | 渐盈能量 |
| 上弦月 | 挑战、决策 | 7 | 蓝色、紫色 | 迷迭香、鼠尾草 | 蓝宝石、紫水晶 | 上弦月能量 |
| 渐盈凸月 | 精炼、调整 | 9 | 金色、黄色 | 向日葵、金盏花 | 黄水晶、琥珀 | 接近满月 |
| 满月 | 清晰、释放、完成 | 15 | 白色、银色 | 茉莉、栀子花 | 白水晶、珍珠 | 满月能量 |
| 渐亏凸月 | 感恩、分享 | 12 | 粉色、玫瑰色 | 玫瑰、天竺葵 | 粉水晶、玫瑰石英 | 渐亏能量 |
| 下弦月 | 宽恕、放下 | 8 | 深蓝色、紫色 | 鼠尾草、薰衣草 | 紫水晶、蓝宝石 | 下弦月能量 |
| 下弦月渐亏 | 休息、反思 | 4 | 灰色、深绿色 | 常春藤、松树 | 黑曜石、玛瑙 | 渐亏至新月 |

### 3.4 元素与幸运元素对应表（降级匹配用）

| 元素 | 幸运数字 | 幸运颜色 | 幸运植物 | 幸运石 | 依据 |
|------|---------|---------|---------|--------|------|
| 火 | 9 | 红色、橙色、金色 | 薄荷、向日葵、金盏花 | 红宝石、琥珀、黄玉 | 火元素特性 |
| 土 | 6 | 绿色、棕色、米色 | 玫瑰、常春藤、鼠尾草 | 祖母绿、玛瑙、蓝宝石 | 土元素特性 |
| 风 | 5 | 黄色、天蓝色、银色 | 薰衣草、紫罗兰、雏菊 | 黄水晶、紫水晶、海蓝宝 | 风元素特性 |
| 水 | 7 | 蓝色、银色、海绿色 | 茉莉、莲花、睡莲 | 珍珠、月光石、海蓝宝 | 水元素特性 |

---

## 四、匹配算法设计

### 4.1 匹配流程

```
1. 获取用户信息
   ├─ 检查是否有完整星盘信息（日期+时间+地点）
   │  └─ 是 → Level 1 匹配（暂不实现，降级到 Level 2）
   │  └─ 否 → 继续
   │
   ├─ 检查是否有星座信息（日期）
   │  └─ 是 → Level 2 匹配（星座+月相+塔罗）
   │  │     ├─ 星座匹配：直接查星座表
   │  │     ├─ 月相匹配：查月相表（作为权重调整）
   │  │     └─ 塔罗匹配：查塔罗表（作为权重调整）
   │  │
   │  └─ 否 → Level 3 匹配（月相+塔罗）
   │        ├─ 月相匹配：查月相表
   │        └─ 塔罗匹配：查塔罗表
   │              ├─ 大阿卡纳 → 查牌ID表
   │              └─ 小阿卡纳 → 查花色元素表 + 提取数字
   │
   └─ 极端情况 → Level 4 匹配（仅塔罗）
```

### 4.2 多维度匹配策略（Level 2）

当用户有星座信息时，采用**加权融合**：

```
幸运数字 = 星座数字（权重60%）+ 月相数字（权重25%）+ 塔罗数字（权重15%）
幸运颜色 = 星座颜色（权重50%）+ 月相颜色（权重30%）+ 塔罗颜色（权重20%）
幸运植物 = 星座植物（权重60%）+ 月相植物（权重40%）
幸运石 = 星座石（权重60%）+ 月相石（权重40%）
```

**选择规则**：
- 如果多个来源有相同值，直接使用
- 如果不同，按权重选择（取权重最高的）
- 颜色/植物/石头：如果有多个，选择第一个（或随机选择一个）

### 4.3 双维度匹配策略（Level 3）

当用户无星座信息时，采用**优先匹配**：

```
幸运数字 = 优先使用塔罗数字，如果没有则使用月相数字
幸运颜色 = 月相颜色（权重60%）+ 塔罗颜色（权重40%）
幸运植物 = 月相植物（权重70%）+ 塔罗植物（权重30%）
幸运石 = 月相石（权重70%）+ 塔罗石（权重30%）
```

### 4.4 塔罗牌数字提取规则

**大阿卡纳**：
- 直接使用牌ID作为数字（0-21）
- 如果ID为0（愚者），使用 22（传统对应）

**小阿卡纳**：
- 数字牌（Ace-10）：直接使用数字（1-10）
- 宫廷牌：
  - Page = 11
  - Knight = 12
  - Queen = 13
  - King = 14

---

## 五、数据结构设计

### 5.1 幸运元素数据表（JavaScript对象）

```javascript
const LUCKY_ELEMENTS_DATA = {
  // 星座表
  zodiac: {
    '白羊座': { element: 'fire', number: 9, colors: ['红色', '橙红色'], plants: ['薄荷', '百里香'], stones: ['红宝石', '石榴石'] },
    '金牛座': { element: 'earth', number: 6, colors: ['绿色', '粉色'], plants: ['玫瑰', '紫罗兰'], stones: ['祖母绿', '粉水晶'] },
    // ... 其他10个星座
  },
  
  // 月相表
  moonPhase: {
    '新月': { number: 1, colors: ['黑色', '深蓝色'], plants: ['茉莉', '栀子花'], stones: ['黑曜石', '月光石'] },
    '上弦月渐盈': { number: 3, colors: ['银色', '浅蓝色'], plants: ['薰衣草', '薄荷'], stones: ['月光石', '白水晶'] },
    // ... 其他6个月相
  },
  
  // 塔罗大阿卡纳表
  tarotMajor: {
    0: { zodiac: '风', element: 'air', number: 22 }, // 愚者
    1: { zodiac: '水星', element: 'air', number: 1 }, // 魔术师
    // ... 其他21张牌
  },
  
  // 塔罗元素表（小阿卡纳）
  tarotElement: {
    'cups': { element: 'water' },
    'swords': { element: 'air' },
    'wands': { element: 'fire' },
    'pentacles': { element: 'earth' }
  },
  
  // 元素默认表（降级用）
  elementDefault: {
    'fire': { number: 9, colors: ['红色', '橙色', '金色'], plants: ['薄荷', '向日葵', '金盏花'], stones: ['红宝石', '琥珀', '黄玉'] },
    'earth': { number: 6, colors: ['绿色', '棕色', '米色'], plants: ['玫瑰', '常春藤', '鼠尾草'], stones: ['祖母绿', '玛瑙', '蓝宝石'] },
    'air': { number: 5, colors: ['黄色', '天蓝色', '银色'], plants: ['薰衣草', '紫罗兰', '雏菊'], stones: ['黄水晶', '紫水晶', '海蓝宝'] },
    'water': { number: 7, colors: ['蓝色', '银色', '海绿色'], plants: ['茉莉', '莲花', '睡莲'], stones: ['珍珠', '月光石', '海蓝宝'] }
  }
};
```

### 5.2 函数接口设计

```javascript
/**
 * 生成幸运元素
 * @param {Object} tarotCard - 塔罗牌对象 {id, name, nameCn, ...}
 * @param {Object} moonPhase - 月相对象 {name, nameCn, emoji, energy}
 * @param {Object} userProfile - 用户信息对象（可选）
 * @returns {Object} 幸运元素对象 {lucky_number, lucky_color, lucky_plant, lucky_stone}
 */
function generateLuckyElements(tarotCard, moonPhase, userProfile = null) {
  // 实现匹配逻辑
}
```

---

## 六、实现步骤

### 6.1 第一阶段：创建数据表
1. 创建 `lucky-elements-data.js` 文件
2. 填写完整的对应关系表
3. 验证数据完整性

### 6.2 第二阶段：实现匹配函数
1. 创建 `lucky-elements.js` 文件
2. 实现 `generateLuckyElements()` 函数
3. 实现降级匹配逻辑
4. 添加单元测试

### 6.3 第三阶段：集成到现有系统
1. 修改 `api.js`，移除 LLM 生成幸运元素的部分
2. 在生成占卜结果时调用 `generateLuckyElements()`
3. 修改 `ui.js`，更新显示逻辑（移除饰品、摆件，新增植物、石头）

### 6.4 第四阶段：测试与优化
1. 测试不同匹配场景（有星座/无星座）
2. 验证降级匹配的用户体验
3. 优化匹配规则（如有必要）

---

## 七、注意事项

1. **数据准确性**：所有对应关系需基于传统占星学/塔罗学依据，不做随意编造
2. **用户体验**：降级匹配需完全无感，用户不应察觉缺失星座信息的影响
3. **一致性**：同一用户、同一日期的匹配结果应一致（不使用随机）
4. **扩展性**：预留星盘匹配接口，未来可升级
5. **性能**：匹配算法应快速执行，不阻塞主流程

---

## 八、待确认事项

1. ✅ 幸运数字是否允许范围（如 1-22，或更大范围）？
2. ✅ 幸运颜色是否允许多个（如显示"红色、橙色"）？
3. ✅ 幸运植物/石头是否允许多个（如显示"薄荷、百里香"）？
4. ✅ 加权融合的具体权重是否需要调整？
5. ✅ 是否需要考虑用户情绪状态对幸运元素的影响？

---

**方案版本**：v1.0  
**创建日期**：2026-01-15  
**待确认后实施**
