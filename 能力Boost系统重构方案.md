# 能量 Boost 系统重构方案

## 一、总体设计

### 1.1 系统改名
- **旧名称**：疗愈任务 / Healing Task
- **新名称**：能量 Boost / Energy Boost

### 1.2 核心变化
1. **生成方式**：从 LLM 生成 → 规则库随机匹配
2. **任务数量**：1个任务 → 3个任务（从8大类中随机选择）
3. **签到规则**：完成每日任务才能签到 → 完成每日占卜即签到
4. **新增功能**：能量值系统（💧）、任务倒计时、换一批功能

---

## 二、任务库设计

### 2.1 8大任务类别

#### 类别1：节律呼吸与延长呼气（Breath Regulation）
**目标**：降生理唤醒、稳定心率节律

任务列表（15个）：
1. 坐下来缓慢呼吸 4次。
2. 自然吸气，慢慢呼气 4次。
3. 呼气更长一点 4次。
4. 用鼻吸气，用口呼气4次。
5. 轻吸轻呼，做 8次。
6. 肩膀放松，深呼吸 4 次。
7. 下巴放松，深呼吸4次。
8. 呼气时轻收腹 4次。
9. 吸气数到 5，再呼气，共4 次。
10. 呼气数到 5，再吸气，共4 次。
11. 张开嘴，舌尖抵住上颚，慢呼吸 4 次。
12. 闭上眼睛，深呼吸 4次。
13. 夸张到好笑的大声叹气 3次。
14. 没有规则想乱就乱的呼吸 10秒。

#### 类别2：渐进性肌肉放松与肌群释放（PMR / Muscle Release）
**目标**：降低躯体紧张、改善"紧绷型焦虑/疲惫"

任务列表（16个）：
1. 耸肩并尽力头部后仰 8 秒。
2. 闭上眼睛眉心松开， 8 秒。
3. 咬肌用力，然后松开， 4次。
4. 闭上眼睛，舌尖抵上颚8 秒。
5. 握拳用力，然后放松，5次。
6. 张开手指再放松 8次。
7. 闭上眼睛，双手抱肩 8 秒。
8. 脚趾抓地再放松 5次。
9. 小腿绷紧再放松 6次。
10. 大腿绷紧再放松 6次。
11. 腹部收紧再放松 6次。
12. 用力闭上眼睛 6次。
13. 鼻翼轻皱再放松 6次。
14. 头向左倾10秒再右10秒。
15. 伸出双臂胡乱挥舞 10 秒。
16. 把舌头尽力伸出，直到笑出来。

#### 类别3：正念·单点专注（Focused Attention Mindfulness）
**目标**：把注意力从"散/飘/反刍"拉回一个锚点

任务列表（12个）：
1. 注视面前一个物体 15秒。
2. 注视一个墙角 15秒。
3. 注视远处一座建筑 15秒。
4. 心中对呼吸计数10轮。
5. 嘈杂中专注只听一种声音 15秒。
6. 用心感受脚底触地 15秒。
7. 用心感受手心温度 15秒。
8. 触摸比体温低的物品 15秒。
9. 触摸比体温高的物品 15秒。
10. 上下左右，目光扫一圈周围环境。
11. 数心跳10下。
12. 说出你最想说的脏话，5 遍！

#### 类别4：正念·开放监测与允许（Open Monitoring / Letting Be）
**目标**：减少卷入与评判，建立"念头来去"的距离

任务列表（12个）：
1. 发呆静坐，完全放空 30秒。
2. 闭上眼睛，感受呼吸起伏 20秒。
3. 闭上眼睛，想象一片海，只有海浪声。
4. 闭上眼睛，想象一片海，和一个漂流瓶。
5. 闭上眼睛，想象一片森林，只有树叶声。
6. 闭上眼睛，想象在云端，只有风声。
7. 闭上眼睛，感受脑海中的第一个念头。
8. 注视窗外，感受脑海中的第一个念头。
9. 仰望天空，感受脑海中的第一个念头。
10. 让所有思绪像云飘过，20秒。
11. 想一个你痛恨的人，默默诅咒。
12. 原地抖 20秒，管它呢。

#### 类别5：Grounding·感官锚定（Sensory Grounding）
**目标**：回到当下、降低灾难化想象与情绪升级

任务列表（10个）：
1. 目光沿着眼前物体边缘游走一圈。
2. 双手捂住耳朵感受声音 20 秒。
3. 按压双侧眉骨，感受轻轻的压力 20 秒。
4. 手心互搓发热 20秒。
5. 找到视野中的白色，注视 20秒。
6. 找到视野中的蓝色，注视 20秒。
7. 找到视野中的绿色，注视 20秒。
8. 眼睛追随一个缓慢移动的物体。
9. 用指尖触摸一个柔软物体 20 秒。
10. 闭上眼睛，让毛孔感受空气的流动 20 秒。
11. 抬头看天花板 20秒。

#### 类别6：Grounding·认知锚定与事实化（Cognitive Grounding）
**目标**：用"事实句/定位句"恢复现实感与控制感

任务列表（10个）：
1. 在心中对自己说：我在这里。
2. 在心中对自己说：慢一点。
3. 在心中告诉自己：我在哪。
4. 在心中告诉自己：现在的时间。
5. 在心中告诉自己：今天的日期。
6. 说出自己的姓名，慢一点。
7. 想象一个愿望变成了现实。
8. 对自己说"我先稳定再处理"。
9. 对自己说"我现在是安全的"。
10. 对自己说"我能只做一小步"。

#### 类别7：行为激活·微行动启动（Behavioral Activation / Micro-action）
**目标**：从瘫住/拖延/迷茫中启动执行系统

任务列表（12个）：
1. 拿起杯子，喝一杯水。
2. 专注的读任意一段话。
3. 在纸上或屏幕上写下你的名字。
4. 整理你的床或桌面。
5. 删除一条无关的信息 。
6. 删除一张不喜欢的照片。
7. 整理一下手机桌面。
8. 打开计时器开始放空 60秒。
9. 认知聆听一小段音乐。
10. 随意吃一点东西，慢慢咀嚼。
11. 找一个简单的任务，完成它。
12. 整理一下你的衣服。
13. 关掉手机屏幕 20 秒。

#### 类别8：问题解决与决策去复杂化（Problem Solving / Decision Simplification）
**目标**：把抽象困扰变成可选项与可执行步骤

任务列表（11个）：
1. 把今天第一个困扰改成二选一。
2. 闭上眼睛，找到今天最重要的一件事。
3. 回忆昨天令人兴奋的一件小事。
4. 写下今天最困扰你的一件事。
5. 把下一个任务拆成三小步。
6. 找一件最省力的事，先去解决。
7. 删掉一个不必要的待办。
8. 给一件棘手的事设定截止点。
9. 给今天最棘手的事起一个俏皮的名字。
10. 拖延一件可以拖延的小事。
11. 放下困扰，什么都不做，"浪费"5 分钟。

### 2.2 任务库统计
- **总类别数**：8 大类
- **总任务数**：约 98 个任务
- **每类任务数**：10-16 个不等

---

## 三、功能设计

### 3.1 任务生成规则

#### 生成时机
1. **首次生成**：完成每日占卜后，自动生成3个任务
2. **刷新生成**：用户点击"换一批♻️"按钮时

#### 生成算法
```
1. 从8个大类中随机选择3个不重复的类别
2. 从每个选中的类别中随机选择1个任务
3. 检查任务是否在今天已出现过或已完成（避免重复）
4. 如果重复，重新选择，直到获得3个不重复的任务
5. 组成3任务列表
```

#### 去重规则
- **换一批时**：不允许出现今天已出现过或已完成的任务
- **记录机制**：维护今日所有出现过的任务ID列表（包括已完成和未完成的）
- **生成逻辑**：从候选任务中排除今日已出现的任务

#### 存储规则
- 每日任务存储在 `localStorage` 中
- Key: `energy_boost_tasks_YYYY-MM-DD`
- 格式：
```javascript
{
  date: "2026-01-15",
  tasks: [
    {
      id: "task_1",
      category: "Breath Regulation",
      categoryCn: "节律呼吸与延长呼气",
      content: "坐下来缓慢呼吸 4次。",
      status: "pending" | "started" | "completed",
      startTime: null, // 开始时间戳
      completedTime: null // 完成时间戳
    },
    // ... 其他2个任务
  ],
  refreshCount: 0 // 换一批的次数
}
```

### 3.2 任务状态管理

#### 状态定义
- **pending（待开始）**：初始状态，显示"开始"按钮
- **started（进行中）**：已点击"开始"，显示倒计时和"完成"按钮
- **completed（已完成）**：已点击"完成"，显示"已完成"状态

#### 状态流转
```
pending → [点击"开始"] → started → [倒计时结束 + 点击"完成"] → completed
```

### 3.3 倒计时功能

#### 实现逻辑
- 点击"开始"后，启动 20 秒倒计时
- 倒计时期间：
  - 显示倒计时数字（20, 19, 18...）
  - "开始"按钮隐藏
  - "完成"按钮显示但**禁用**（灰色，不可点击）
- 倒计时结束后：
  - "完成"按钮**启用**（高亮，可点击）
  - 用户可以点击"完成"

#### 技术实现
- 使用 `setInterval` 实现倒计时
- 每个任务独立倒计时
- **页面刷新处理**：如果任务处于倒计时中，恢复"开始"按钮状态（不恢复倒计时）

### 3.4 换一批功能

#### 交互逻辑
- 位置：任务容器右上角
- 图标：♻️
- 点击后：
  1. 立即生成新的3个任务（按生成规则）
  2. 替换当前显示的3个任务
  3. 无论已有任务是否完成，都替换
  4. 更新 `refreshCount` 计数

#### 限制规则
- **无限制**：用户可以无限次刷新
- **去重机制**：换一批后不允许出现今天已出现过或已完成的任务
- **能量值不受影响**：换一批不会影响已产出的能量值，已完成的任务已计入能量值

### 3.5 能量值系统（💧）

#### 获取规则
- **完成任务**：每完成1个任务 = 5点能量值
- **每日上限**：当日完成的前5个任务产出能量值（5 × 5 = 25点/天）
- **换一批不影响**：换一批后，之前已完成的任务已计入能量值，不会重复计算
- **其他获取方式**：待定（未来扩展）

#### 存储规则
- 存储在 `localStorage` 中
- Key: `user_energy_points`
- **初始值**：新用户初始能量值为 0
- **历史保留**：能量值历史记录保存 3 天，超过3天的记录自动清理
- 格式：
```javascript
{
  total: 150, // 总能量值
  history: [
    {
      date: "2026-01-15",
      earned: 25, // 当日获得
      source: "tasks", // 来源：tasks / 其他（未来扩展）
      tasksCompleted: 5 // 当日完成任务数
    },
    {
      date: "2026-01-14",
      earned: 20,
      source: "tasks",
      tasksCompleted: 4
    },
    {
      date: "2026-01-13",
      earned: 15,
      source: "tasks",
      tasksCompleted: 3
    }
    // 只保留最近3天的记录
  ],
  lastUpdated: "2026-01-15T10:30:00.000Z"
}
```

#### 显示位置
- **主界面顶部**：日期右侧
- 格式：`January 15  💧 150`
- 样式：能量值用💧图标 + 数字显示

#### 消耗规则
- **待定**：未来扩展功能使用

### 3.6 签到规则变更

#### 旧规则
- 完成每日占卜 + 完成每日任务 = 签到成功

#### 新规则
- **完成每日占卜** = 签到成功
- **触发时机**：完成占卜后首次进入"今日"主界面时自动弹出签到成功弹板
- **去重机制**：使用 `localStorage` 标记 `checkin_toast_shown_YYYY-MM-DD`，避免重复弹出
- 不再检查任务完成状态

#### 补签规则
- **保持不变**：补签功能逻辑不变

---

## 四、UI/UX 设计

### 4.1 模块改名
- **旧名称**：疗愈 Boost / Healing Boost
- **新名称**：能量 Boost / Energy Boost

### 4.2 任务列表UI

#### 容器结构
```
┌─────────────────────────────────────┐
│  能量 Boost              [换一批♻️]  │
├─────────────────────────────────────┤
│  ┌───────────────────────────────┐ │
│  │ 任务1内容...    [开始] [完成]  │ │
│  │ (不显示类别名称)              │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 任务2内容...    [开始] [完成]  │ │
│  └───────────────────────────────┘ │
│  ┌───────────────────────────────┐ │
│  │ 任务3内容...    [开始] [完成]  │ │
│  └───────────────────────────────┘ │
└─────────────────────────────────────┘
```

#### UI说明
- **不显示类别名称**：任务卡片中只显示任务内容，不显示任务类别
- **换一批按钮**：直接刷新，无需确认弹窗

#### 任务卡片状态

**状态1：待开始（pending）**
- 显示：任务内容 + "开始"按钮
- "完成"按钮：隐藏

**状态2：进行中（started）**
- 显示：任务内容 + 倒计时数字（20, 19, 18...） + "完成"按钮（禁用状态，灰色）
- "开始"按钮：隐藏
- 倒计时格式：只显示数字 `15`、`14`、`13`...
- 倒计时结束后："完成"按钮启用（高亮，可点击）

**状态3：已完成（completed）**
- 显示：任务内容 + "✓ 已完成"
- "开始"和"完成"按钮：隐藏

### 4.3 能量值显示

#### 位置
- 主界面顶部，日期右侧
- 格式：`January 15  💧 150`

#### 样式
- 💧 图标：emoji 或 SVG
- 数字：与日期相同的字体大小和颜色

---

## 五、数据结构设计

### 5.1 任务库数据结构

```javascript
const ABILITY_BOOST_TASKS = {
  "Breath Regulation": {
    nameCn: "节律呼吸与延长呼气",
    goal: "降生理唤醒、稳定心率节律",
    tasks: [
      "坐下来缓慢呼吸 4次。",
      "自然吸气，慢慢呼气 4次。",
      // ... 其他任务
    ]
  },
  "PMR": {
    nameCn: "渐进性肌肉放松与肌群释放",
    goal: "降低躯体紧张、改善"紧绷型焦虑/疲惫"",
    tasks: [
      "耸肩并尽力头部后仰 8 秒。",
      // ... 其他任务
    ]
  },
  // ... 其他6个类别
};
```

### 5.2 每日任务存储结构

```javascript
{
  date: "2026-01-15",
  tasks: [
    {
      id: "task_1_20260115",
      category: "Breath Regulation",
      categoryCn: "节律呼吸与延长呼气",
      content: "坐下来缓慢呼吸 4次。",
      status: "pending", // pending | started | completed
      startTime: null, // 开始时间戳（ISO格式）
      completedTime: null, // 完成时间戳
      countdownRemaining: null // 倒计时剩余秒数（用于页面刷新恢复）
    },
    {
      id: "task_2_20260115",
      category: "PMR",
      categoryCn: "渐进性肌肉放松与肌群释放",
      content: "耸肩并尽力头部后仰 8 秒。",
      status: "completed",
      startTime: "2026-01-15T10:30:00.000Z",
      completedTime: "2026-01-15T10:30:20.000Z",
      countdownRemaining: null
    },
    {
      id: "task_3_20260115",
      category: "Focused Attention",
      categoryCn: "正念·单点专注",
      content: "注视面前一个物体 15秒。",
      status: "started",
      startTime: "2026-01-15T10:35:00.000Z",
      completedTime: null,
      countdownRemaining: 12 // 倒计时剩余12秒（页面刷新时，如果倒计时中，恢复为pending状态）
    }
  ],
  refreshCount: 2, // 换一批的次数
  generatedAt: "2026-01-15T10:00:00.000Z", // 生成时间
  todayAppearedTaskIds: [
    // 今日所有出现过的任务ID列表（包括已完成和未完成的），用于换一批时去重
    "task_1_20260115",
    "task_2_20260115",
    "task_3_20260115",
    // ... 换一批后新增的任务ID也会加入此列表
  ]
}
```

### 5.4 任务完成统计存储结构

```javascript
{
  date: "2026-01-15",
  categoryStats: {
    "Breath Regulation": 2, // 完成的任务数
    "PMR": 1,
    "Focused Attention": 0,
    // ... 其他类别
  },
  totalCompleted: 3 // 当日总完成任务数
}
```

### 5.3 能量值存储结构

```javascript
{
  total: 150, // 总能量值（初始值为0）
  history: [
    {
      date: "2026-01-15",
      earned: 25,
      source: "tasks",
      tasksCompleted: 5 // 当日完成任务数
    },
    {
      date: "2026-01-14",
      earned: 20,
      source: "tasks",
      tasksCompleted: 4
    },
    {
      date: "2026-01-13",
      earned: 15,
      source: "tasks",
      tasksCompleted: 3
    }
    // 只保留最近3天的记录，超过3天的自动清理
  ],
  lastUpdated: "2026-01-15T10:30:00.000Z"
}
```

---

## 六、核心函数设计

### 6.1 任务生成函数

```javascript
/**
 * 生成3个随机任务
 * @param {Array} excludeTaskIds - 需要排除的任务ID列表（今日已出现过的任务）
 * @returns {Array} 3个任务对象数组
 */
function generateEnergyBoostTasks(excludeTaskIds = []) {
  // 1. 从8个大类中随机选择3个不重复的类别
  // 2. 从每个类别中随机选择1个任务
  // 3. 检查任务是否在 excludeTaskIds 中（避免重复）
  // 4. 如果重复，重新选择，直到获得3个不重复的任务
  // 5. 返回任务数组
}
```

### 6.2 任务状态管理函数

```javascript
/**
 * 开始任务（启动倒计时）
 * @param {string} taskId - 任务ID
 */
function startEnergyBoostTask(taskId) {
  // 1. 更新任务状态为 started
  // 2. 记录开始时间
  // 3. 启动20秒倒计时
  // 4. 更新UI
}

/**
 * 完成任务
 * @param {string} taskId - 任务ID
 */
function completeEnergyBoostTask(taskId) {
  // 1. 检查倒计时是否结束（必须等倒计时结束才能完成）
  // 2. 更新任务状态为 completed
  // 3. 记录完成时间
  // 4. 更新任务完成统计（类别分布）
  // 5. 检查是否应该获得能量值（当日完成的前5个任务）
  // 6. 更新能量值（如果符合条件）
  // 7. 更新UI
}
```

### 6.3 能量值管理函数

```javascript
/**
 * 增加能量值
 * @param {number} points - 能量值点数
 * @param {string} source - 来源（如 "tasks"）
 */
function addEnergyPoints(points, source = "tasks") {
  // 1. 读取当前能量值
  // 2. 增加能量值
  // 3. 更新历史记录
  // 4. 更新UI显示
}

/**
 * 获取当前能量值
 * @returns {number} 总能量值
 */
function getEnergyPoints() {
  // 返回总能量值
}

/**
 * 检查当日已完成任务数（用于判断是否应该获得能量值）
 * @returns {number} 当日已完成任务数
 */
function getTodayCompletedTaskCount() {
  // 统计当日已完成的任务数（包括换一批前的任务）
  // 用于判断是否在前5个任务内
}

/**
 * 更新任务完成统计（类别分布）
 * @param {string} category - 任务类别
 */
function updateTaskCompletionStats(category) {
  // 1. 读取当日任务完成统计
  // 2. 更新对应类别的完成数
  // 3. 更新总完成数
  // 4. 保存到 localStorage
}
```

### 6.4 签到逻辑修改

```javascript
/**
 * 检查并显示签到成功弹板
 * 新规则：完成每日占卜后，首次进入主界面即弹出
 */
function checkAndShowCheckInToast() {
  // 1. 检查是否已完成今日占卜
  // 2. 检查 localStorage 中是否已显示过签到弹板（key: checkin_toast_shown_YYYY-MM-DD）
  // 3. 如果已完成占卜且未显示过，弹出签到成功弹板
  // 4. 标记已显示（设置 localStorage 标记）
}
```

---

## 七、实现步骤

### 7.1 第一阶段：创建任务库
1. 创建 `energy-boost-tasks-data.js` 文件
2. 填写8大类任务数据
3. 验证数据完整性

### 7.2 第二阶段：实现任务生成和状态管理
1. 创建 `energy-boost.js` 文件
2. 实现任务生成函数
3. 实现任务状态管理函数
4. 实现倒计时功能
5. 实现换一批功能

### 7.3 第三阶段：实现能量值系统
1. 创建 `energy-points.js` 文件
2. 实现能量值存储和读取
3. 实现能量值增加逻辑
4. 在主界面显示能量值

### 7.4 第四阶段：修改签到逻辑
1. 修改 `main.js` 或相关文件
2. 移除任务完成检查
3. 实现新的签到弹板触发逻辑

### 7.5 第五阶段：更新UI
1. 修改 `index.html`，更新模块名称和结构
2. 修改 `ui.js`，更新渲染逻辑
3. 修改 `style.css`，更新样式
4. 添加倒计时UI样式

### 7.6 第六阶段：集成和测试
1. 集成所有功能
2. 测试任务生成、状态管理、倒计时
3. 测试能量值系统
4. 测试签到逻辑

---

## 八、已确认问题与答案

### 8.1 任务相关
1. ✅ **任务数量**：固定3个任务
2. ✅ **任务重复**：换一批后不允许出现今天已出现过或已完成的任务
3. ✅ **任务完成状态**：完成任意任务即可产出💧，换一批不会影响已产出💧
4. ✅ **倒计时规则**：必须等倒计时结束，"完成"按钮才亮可点
5. ✅ **任务持久化**：页面刷新后，任务状态保留，但如果是倒计时中，则恢复"开始"按钮

### 8.2 能量值相关
6. ✅ **能量值上限**：每日前5个任务获得能量值，是指"当日完成的前5个任务"
7. ✅ **能量值显示**：能量值在主界面顶部显示（暂不提供详情查看功能）
8. ✅ **能量值初始化**：新用户初始能量值为 0

### 8.3 签到相关
9. ✅ **签到弹板时机**："完成占卜后首次进入主界面"
10. ✅ **签到弹板去重**：使用 localStorage 标记 `checkin_toast_shown_YYYY-MM-DD`

### 8.4 UI/UX相关
11. ✅ **倒计时显示**：倒计时只显示数字"15、14……"
12. ✅ **任务卡片样式**：不需要显示任务类别名称
13. ✅ **换一批按钮**：直接刷新，无需确认弹窗

### 8.5 数据统计相关
14. ✅ **任务完成统计**：需要统计用户完成的任务类别分布
15. ✅ **能量值历史**：能量值历史记录需要保存 3 天

---

## 九、技术细节

### 9.1 随机算法
- 使用 `Math.random()` 实现随机选择
- 确保3个类别不重复
- 确保任务选择随机性

### 9.2 倒计时实现
- 使用 `setInterval` 每秒更新
- 使用 `Date.now()` 记录开始时间，避免页面刷新丢失
- **页面刷新处理**：如果任务处于倒计时中（status = "started"），恢复为"开始"按钮状态（status = "pending"），不恢复倒计时
- **完成按钮控制**：倒计时期间，"完成"按钮禁用（disabled），倒计时结束后启用

### 9.3 状态持久化
- 使用 `localStorage` 存储每日任务状态
- 使用 `localStorage` 存储能量值
- 使用 `localStorage` 存储任务完成统计（类别分布）
- 使用 `localStorage` 存储签到弹板显示标记
- **能量值历史清理**：自动清理超过3天的历史记录
- **任务状态刷新处理**：页面刷新时，倒计时中的任务恢复为"开始"状态

---

**方案版本**：v1.1  
**创建日期**：2026-01-15  
**更新日期**：2026-01-15  
**状态**：✅ 已确认，待实施
