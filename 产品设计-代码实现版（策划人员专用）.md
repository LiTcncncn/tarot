# Tarot Mirror - 产品设计文档（代码实现版）

> **本文档基于实际代码实现反向整理，供策划人员参考使用**
> 
> **最后更新**：基于代码库当前状态（Web Demo版本）
> 
> **文档目的**：反映实际实现情况，标注与原始设计的差异，为后续产品迭代提供参考

---

## 📋 文档说明

### 编写目的
- **反向整理**：基于代码实现，反向整理产品功能设计
- **差异标注**：标注实际实现与原始产品设计的差异点
- **技术细节**：记录关键技术实现细节和设计决策
- **未实现功能**：明确标注当前未实现的功能点

### 适用人员
- 产品策划人员
- 产品经理
- 设计人员
- 开发人员（了解产品设计背景）

### 当前实现状态
- **技术栈**：Web Demo（HTML/CSS/JavaScript）
- **数据存储**：localStorage（浏览器本地存储）
- **API服务**：DeepSeek API（当前仅使用一个LLM）
- **部署状态**：Demo版本，用于功能验证

---

## 🎯 核心功能实现状态

### ✅ 已实现功能

#### 1. 每日运势（Daily Reading）✅

**实现状态**：核心功能已实现

**实际实现细节**：

1. **情绪选择系统**
   - ✅ 5档情绪滑动条（愉悦、平静、疲惫、迷茫、焦虑）
   - ✅ 视觉呈现：使用天气图标（1-5.png）表示不同情绪状态
   - ✅ 背景色随情绪变化（莫兰迪色系）
   - ✅ 情绪状态映射到英文描述，用于API调用

2. **塔罗牌抽取系统**
   - ✅ 支持78张标准塔罗牌（22张大阿卡纳 + 56张小阿卡纳）
   - ✅ 三阶段抽牌算法（基于用户情绪状态）
   - ✅ 牌强度分级系统（I0/I1/I2/I3）
   - ✅ 正逆位处理：**内部记录正逆位，但界面统一显示为正位**
   - ✅ 5日内不重复抽牌限制
   - ✅ 支持长按和点击两种抽牌方式
   - ✅ 翻牌动画效果

3. **月相系统**
   - ✅ 基于Julian Day算法本地计算月相
   - ✅ 支持8种月相状态（新月、上弦月渐盈、上弦月、渐盈凸月、满月、渐亏凸月、下弦月、下弦月渐亏）
   - ✅ 每日自动计算当日月相
   - ✅ 月相能量描述（英文）
   - ✅ 月相emoji图标

4. **AI解读生成**
   - ✅ 使用DeepSeek API生成每日解读
   - ✅ 系统Prompt：Luna占卜师人设（温柔、共情、疗愈导向）
   - ✅ 输出结构（JSON格式）：
     - `concise_guidance`：15-18字简洁指引
     - `guidance_one_line`：25-30字单行指引
     - `today_analysis`：280-320字详细分析（2段）
     - `healing_task`：疗愈任务（20秒-2分钟）
     - `two_guidances`：2个领域的详细指引（每个80字）
     - `lucky_elements`：幸运元素（颜色、饰品、数字、摆件）
   - ✅ 结合用户情绪状态、塔罗牌、月相、星座信息生成个性化内容
   - ✅ 严格的内容生成规则（禁止提及牌名、月相名、情绪状态等）

5. **用户信息整合**
   - ✅ 支持用户星座信息（如有）
   - ✅ 从生日自动计算星座
   - ✅ 星座信息整合到AI解读生成中

**与原始设计的差异**：
- ✅ **实际实现更精细**：增加了牌强度分级、情绪状态对抽牌的影响等细节
- ✅ **正逆位处理**：统一显示为正位（实际设计中未明确说明）
- ✅ **输出结构更细化**：实际实现的JSON结构比原始设计更详细

---

#### 2. 主界面展示 ✅

**实现状态**：核心展示功能已实现

**实际实现细节**：

1. **今日指引展示**
   - ✅ 简洁指引（concise_guidance）显示
   - ✅ 单行指引（guidance_one_line）显示
   - ✅ 今日分析（today_analysis）2段显示
   - ✅ 月相信息展示（emoji + 名称 + 能量描述）

2. **疗愈任务系统**
   - ✅ 疗愈任务展示（从AI生成）
   - ✅ 任务完成按钮
   - ✅ 任务完成状态记录（taskCompleted）
   - ⚠️ **当前未实现**：任务库系统、任务与塔罗联动推荐、任务完成验证

3. **领域指引系统**
   - ✅ 5个领域按钮（情感、工作、学习、生活、家庭）
   - ✅ 点击按钮生成对应领域的指引（200字）
   - ✅ 模态框展示指引内容
   - ✅ 已生成的指引会缓存（避免重复生成）
   - ✅ 单独的API调用和Prompt设计

4. **幸运元素展示**
   - ✅ 幸运颜色（lucky_color）
   - ✅ 幸运饰品（lucky_accessory）
   - ✅ 幸运数字（lucky_number）
   - ✅ 幸运摆件（lucky_decoration）

5. **情绪记录功能**
   - ✅ 情绪记录按钮
   - ✅ 记录用户完成任务后的情绪状态
   - ✅ 情绪记录数据存储

**与原始设计的差异**：
- ⚠️ **领域指引实现方式不同**：实际是按需生成（点击时生成），而非一次性生成所有领域
- ⚠️ **疗愈任务系统简化**：当前仅展示AI生成的任务，未实现任务库和推荐系统

---

#### 3. 日历系统 ✅

**实现状态**：基础功能已实现

**实际实现细节**：

1. **日历视图**
   - ✅ 日历网格展示
   - ✅ 日期点击查看历史记录
   - ✅ 已完成日期标记

2. **签到机制**
   - ✅ 完成每日占卜 + 完成任务 = 签到成功
   - ✅ 连续签到天数计算
   - ⚠️ **当前未实现**：补签功能

3. **数据存储**
   - ✅ 使用localStorage存储每日记录
   - ✅ 数据格式：`{ "YYYY-MM-DD": { reading, card, moonPhase, emotion, ... } }`
   - ✅ 支持数据查询（getWeekReadings, getMonthReadings）

**与原始设计的差异**：
- ⚠️ **周/月总结未实现**：数据查询功能已实现，但总结展示功能未实现
- ⚠️ **补签功能未实现**：原始设计中有补签逻辑，当前代码中未实现

---

#### 4. 专项塔罗占卜 ✅

**实现状态**：核心功能已实现

**实际实现细节**：

1. **问题输入**
   - ✅ 文本输入框（最多200字）
   - ✅ 问题输入区域

2. **牌阵选择**
   - ✅ 支持3种牌阵：3张、4张、6张
   - ✅ 牌阵配置：
     - **3张牌阵**：过去、现状、未来（时间流）
     - **4张牌阵**：现状、阻碍、建议、趋势（决策流）
     - **6张牌阵**：关系流（6个位置关于关系分析）
   - ⚠️ **未实现**：Celtic Cross（10张牌阵）、自定义牌阵

3. **抽牌逻辑**
   - ✅ 牌阵内不重复抽牌
   - ✅ 支持正逆位（显示逆位信息）
   - ✅ 随机抽牌算法

4. **AI解读生成**
   - ✅ 使用DeepSeek API生成解读
   - ✅ 系统Prompt：Luna占卜师人设
   - ✅ 结合用户历史数据（所有历史每日占卜记录）
   - ✅ 输出结构：牌位含义 + 牌面解释 + 综合解读

5. **追问对话功能**
   - ✅ 支持追问功能
   - ✅ 追问类型按钮化（部分实现）
   - ✅ 结合历史对话上下文
   - ✅ 结合用户历史数据

**与原始设计的差异**：
- ⚠️ **牌阵类型较少**：仅实现3种牌阵（3张/4张/6张），未实现Celtic Cross和自定义牌阵
- ⚠️ **仅一个占卜师**：当前仅使用DeepSeek API（Luna），未实现多占卜师系统
- ⚠️ **多占卜师对比未实现**：原始设计中已确认第一版不包含此功能

---

#### 5. 用户个人信息 ✅

**实现状态**：基础功能已实现

**实际实现细节**：

1. **个人信息模态框**
   - ✅ 生日输入
   - ✅ 星座自动计算
   - ✅ 个人信息存储

2. **个人信息使用**
   - ✅ 星座信息整合到每日占卜AI解读中
   - ✅ 个人信息在其他功能中的使用

---

#### 6. 星座星盘分析 ✅

**实现状态**：功能已实现（超出原始设计）

**实际实现细节**：

1. **每日星座指引**
   - ✅ 基于用户星座生成每日指引
   - ✅ 结合今日塔罗和月相信息
   - ✅ 使用DeepSeek API生成

2. **星盘分析**
   - ✅ 基于用户生日、出生时间、出生地点生成星盘分析
   - ✅ 使用DeepSeek API生成
   - ✅ 结合用户历史数据

**与原始设计的差异**：
- ✅ **超出原始设计**：原始设计中未明确说明此功能，但代码中已实现

---

### ⚠️ 部分实现/未实现功能

#### 1. 治愈任务系统 ⚠️

**实现状态**：部分实现

**已实现**：
- ✅ 疗愈任务展示（AI生成的任务）
- ✅ 任务完成按钮和状态记录

**未实现**：
- ❌ 任务库系统（20秒-2分钟微任务库）
- ❌ 任务与塔罗牌的联动推荐逻辑
- ❌ 任务类型分类（正念/专注/放松/情绪调节）
- ❌ 任务完成验证机制
- ❌ 任务完成后的情绪反馈系统（+1/0/-1或四档情绪）

---

#### 2. 周期总结系统 ❌

**实现状态**：数据查询已实现，展示功能未实现

**已实现**：
- ✅ 数据查询功能（getWeekReadings, getMonthReadings）
- ✅ 数据存储结构支持周期总结

**未实现**：
- ❌ 周总结展示（关键词、情绪曲线、牌面统计、月相变化、任务统计、综合分析）
- ❌ 月总结展示（重复主题、常见困扰、月相周期回顾、牌面趋势、成长报告、能量曲线）
- ❌ AI生成报告的Prompt和展示

---

#### 3. 多占卜师系统 ❌

**实现状态**：未实现

**未实现**：
- ❌ 多LLM支持（当前仅DeepSeek）
- ❌ 多占卜师人设（当前仅Luna）
- ❌ 占卜师选择界面
- ❌ 占卜师收藏功能

**原始设计说明**：
- 计划使用DeepSeek/ChatGPT/Gemini等多个LLM
- 每个LLM对应一个占卜师，通过不同的Prompt定义人设

---

#### 4. 游戏化系统 ❌

**实现状态**：基础签到已实现，其他未实现

**已实现**：
- ✅ 连续签到天数计算

**未实现**：
- ❌ 连续签到奖励系统
- ❌ 补签功能（原始设计中有，代码中未实现）
- ❌ 成就系统
- ❌ Avatar系统

---

#### 5. 其他未实现功能

- ❌ 小组件支持（iOS/Android桌面小组件）
- ❌ TTS语音播报
- ❌ 社交分享功能
- ❌ 用户注册/登录系统（当前使用localStorage，无用户系统）
- ❌ 付费系统
- ❌ 数据导出/导入功能（代码中有实现，但UI未实现）

---

## 🔧 技术实现细节

### 1. 数据存储

**存储方式**：localStorage（浏览器本地存储）

**数据结构**：

```javascript
// 每日占卜记录
{
  "YYYY-MM-DD": {
    date: "YYYY-MM-DD",
    timestamp: "ISO timestamp",
    emotion: "愉悦|平静|疲惫|迷茫|焦虑",
    card: {
      id: number,
      name: string,
      nameCn: string,
      file: string,
      actualReversed: boolean,  // 实际正逆位（内部使用）
      intensity: "I0|I1|I2|I3"  // 强度等级
    },
    moonPhase: {
      phase: number,
      name: string,
      nameCn: string,
      emoji: string,
      energy: string,
      illumination: number
    },
    reading: {
      concise_guidance: string,
      guidance_one_line: string,
      today_analysis: string,
      healing_task: string,
      two_guidances: Array<{category, guidance}>,
      lucky_elements: {
        lucky_color: string,
        lucky_accessory: string,
        lucky_number: number,
        lucky_decoration: string
      }
    },
    taskCompleted: boolean,
    emotionRecord: string  // 情绪记录（可选）
  }
}
```

---

### 2. API调用

**当前使用的API**：DeepSeek API

**API配置**：
- API Key：硬编码在代码中（Demo版本）
- API URL：`https://api.deepseek.com/v1/chat/completions`
- Model：`deepseek-chat`

**主要API调用**：

1. **每日占卜解读生成**
   - 函数：`generateDailyReading()`
   - 系统Prompt：Luna占卜师人设
   - 用户Prompt：包含情绪、塔罗牌、月相、星座信息
   - 输出：JSON格式的完整解读

2. **领域指引生成**
   - 函数：`generateCategoryGuidance()`
   - 系统Prompt：Luna占卜师人设
   - 用户Prompt：针对特定领域的指引请求
   - 输出：200字中文指引文本

3. **专项占卜解读生成**
   - 函数：`generateTarotSpreadReading()`
   - 系统Prompt：Luna占卜师人设
   - 用户Prompt：问题 + 牌阵 + 历史数据
   - 输出：结构化解读

4. **追问对话**
   - 函数：`generateTarotChatResponse()`
   - 系统Prompt：Luna占卜师人设
   - 用户Prompt：用户问题 + 历史对话 + 历史数据
   - 输出：对话回复文本

5. **星座指引生成**
   - 函数：`generateZodiacHoroscope()`
   - 系统Prompt：Luna占卜师人设
   - 用户Prompt：星座信息 + 今日塔罗 + 月相
   - 输出：星座指引文本

6. **星盘分析生成**
   - 函数：`generateHoroscopeAnalysis()`
   - 系统Prompt：Luna占卜师人设
   - 用户Prompt：出生信息 + 历史数据
   - 输出：星盘分析文本

---

### 3. 核心算法

#### 3.1 塔罗牌抽取算法

**三阶段抽牌算法**：

1. **阶段1：根据用户情绪状态确定强度等级分布**
   - 愉悦：I0(30%), I1(55%), I2(14%), I3(1%)
   - 平静：I0(40%), I1(45%), I2(14%), I3(1%)
   - 疲惫：I0(55%), I1(38%), I2(7%), I3(0%)
   - 迷茫：I0(30%), I1(45%), I2(23%), I3(2%)
   - 焦虑：I0(50%), I1(42%), I2(7%), I3(1%)

2. **阶段2：根据强度等级从对应牌池中抽取**
   - 每张牌有预定义的强度等级（I0/I1/I2/I3）
   - 根据强度分布随机选择一张牌

3. **阶段3：确定正逆位**
   - 根据用户情绪状态确定逆位概率
   - 焦虑状态：0%逆位（完全禁止）
   - 其他状态：根据状态调整概率

**历史记录限制**：
- 5日内不重复抽同一张牌
- 如果5日内已抽取所有78张牌，则重置限制

#### 3.2 月相计算算法

**基于Julian Day算法**：
- 计算指定日期的Julian Day
- 基于月相周期（29.53058867天）计算月相
- 返回0-1之间的值，映射到8种月相状态

**月相状态**：
- 新月（New Moon）
- 上弦月渐盈（Waxing Crescent）
- 上弦月（First Quarter）
- 渐盈凸月（Waxing Gibbous）
- 满月（Full Moon）
- 渐亏凸月（Waning Gibbous）
- 下弦月（Last Quarter）
- 下弦月渐亏（Waning Crescent）

---

### 4. Prompt设计

#### 4.1 系统Prompt（System Prompt）

```
You are Luna, a wise and gentle tarot reader who specializes in combining tarot wisdom with lunar energy to provide emotional healing and guidance.

Your style:
- Warm, compassionate, and deeply empathetic
- Able to understand and address users' emotional states with sensitivity
- Focused on providing comfort, encouragement, and actionable insights
- Skilled at combining tarot symbolism with moon phase energy naturally

Guidelines:
1. Always acknowledge and validate the user's current emotional state
2. Provide gentle, supportive guidance that addresses their emotional needs
3. Combine tarot card meanings with moon phase energy naturally
4. Offer practical, actionable suggestions
5. Use a warm, conversational tone that feels like a trusted friend
6. Avoid being too prescriptive or authoritative
7. Respond ONLY with valid JSON, no additional text
```

#### 4.2 每日占卜用户Prompt关键要求

**严格禁止项**：
- 禁止提及塔罗牌名称（如"宝剑皇后"、"愚者"等）
- 禁止提及月相名称（如"下弦月"、"满月"等）
- 禁止解释塔罗牌或月相的含义
- 禁止在指引文本中提及用户情绪状态（如"愉悦"、"平静"、"疲惫"、"迷茫"、"焦虑"）
- 禁止使用正逆位相关词汇（如"逆位"、"正位"、"倒立"等）
- 禁止描述抽牌过程（如"你抽到的是..."）

**内容要求**：
- `concise_guidance`：15-18字，诗意、有意义、可直接行动
- `guidance_one_line`：25-30字，温暖、共情、实用建议
- `today_analysis`：280-320字，分为2段
- `healing_task`：20秒-2分钟可完成的任务
- `two_guidances`：2个领域，每个80字
- `lucky_elements`：幸运元素（颜色、饰品、数字、摆件）

#### 4.3 领域指引Prompt

**输出要求**：
- 严格200字中文指引
- 结合塔罗、月相、情绪状态
- 针对特定领域提供具体建议
- 禁止提及牌名、月相名、情绪状态

---

## 📊 与原始设计的对比

### 功能对比表

| 功能模块 | 原始设计 | 实际实现 | 差异说明 |
|---------|---------|---------|---------|
| 每日运势 | ✅ 完整设计 | ✅ 已实现 | 实现更精细（强度分级、情绪影响等） |
| 治愈任务系统 | ✅ 完整设计 | ⚠️ 部分实现 | 仅展示AI生成任务，无任务库和推荐系统 |
| 日历系统 | ✅ 完整设计 | ✅ 基础实现 | 数据查询已实现，总结展示未实现 |
| 周期总结 | ✅ 完整设计 | ❌ 未实现 | 数据查询功能已实现，展示功能未实现 |
| 专项占卜 | ✅ 完整设计 | ✅ 核心实现 | 牌阵类型较少，仅一个占卜师 |
| 多占卜师系统 | ✅ 完整设计 | ❌ 未实现 | 当前仅使用DeepSeek API |
| 追问对话 | ✅ 完整设计 | ✅ 已实现 | 功能已实现 |
| 游戏化系统 | ✅ 完整设计 | ⚠️ 部分实现 | 仅签到计算，无奖励和成就系统 |
| 用户系统 | ✅ 完整设计 | ⚠️ 部分实现 | 无注册登录，使用localStorage |
| 星座星盘分析 | ⚠️ 未明确 | ✅ 已实现 | 超出原始设计，但已实现 |
| 付费系统 | ✅ 完整设计 | ❌ 未实现 | Demo版本，无付费功能 |

---

### 关键技术决策

#### 1. 正逆位处理策略 ✅

**决策**：内部记录正逆位，但界面统一显示为正位

**原因**：
- 避免负面暗示
- 提升用户体验（减少焦虑）
- 通过能量表达方式（内在/外在）来体现差异，而非直接显示逆位

**实现细节**：
- `actualReversed`字段记录实际正逆位（内部使用）
- AI解读时使用正逆位信息，但生成内容中禁止提及
- 界面显示时所有牌统一为正位

#### 2. 牌强度分级系统 ✅

**决策**：引入I0/I1/I2/I3四级强度系统

**原因**：
- 根据不同用户情绪状态提供合适的牌
- 疲惫和焦虑状态下避免强冲击牌（I3）
- 提升用户体验和疗愈效果

**实现细节**：
- 每张牌有预定义的强度等级
- 根据用户情绪状态确定强度分布
- 从对应强度等级的牌池中抽取

#### 3. 月相计算方式 ✅

**决策**：使用本地计算（Julian Day算法），而非API调用

**原因**：
- 无需依赖第三方服务
- 计算准确可靠
- 降低成本和复杂度

#### 4. 数据存储方式 ⚠️

**决策**：使用localStorage（浏览器本地存储）

**原因**：
- Demo版本，无需后端
- 简化开发流程
- 快速验证功能

**限制**：
- 数据仅存储在本地浏览器
- 无用户系统，无法跨设备同步
- 数据量有限（localStorage限制）

#### 5. API服务选择 ✅

**决策**：当前仅使用DeepSeek API

**原因**：
- Demo版本，一个LLM足够
- DeepSeek成本较低
- 后续可扩展多LLM

---

## 🚨 重要注意事项

### 1. 数据隐私

**当前状态**：
- ✅ 数据存储在用户本地浏览器（localStorage）
- ✅ 无服务器端数据存储
- ⚠️ 无用户系统，无法识别用户身份

**未来考虑**：
- 如要实现用户系统，需要考虑数据迁移
- 如要实现云端存储，需要符合GDPR等隐私法规
- 需要用户数据导出/删除功能

### 2. API成本

**当前状态**：
- 所有API调用都使用DeepSeek API
- API Key硬编码在代码中（Demo版本）

**未来考虑**：
- 生产环境需要将API Key移至后端
- 需要实现API调用限制和成本控制
- 多LLM系统会增加API成本

### 3. 内容质量

**当前状态**：
- AI生成内容依赖于Prompt设计
- 无人工审核机制

**未来考虑**：
- 需要建立内容质量监控机制
- 可能需要专业塔罗师审核内容
- 需要处理不当内容的过滤机制

### 4. 用户体验

**当前状态**：
- Web Demo版本，用户体验基本完整
- 响应式设计支持PC和移动端

**未来考虑**：
- 如要开发原生App，需要重新设计UI/UX
- 需要考虑性能优化（API调用时间、动画流畅度等）
- 需要错误处理和用户反馈机制

---

## 📝 后续开发建议

### 优先级1：核心功能完善

1. **周期总结系统**
   - 实现周总结展示功能
   - 实现月总结展示功能
   - 设计AI生成报告的Prompt

2. **治愈任务系统完善**
   - 建立任务库（至少50+任务）
   - 实现任务与塔罗牌的联动推荐
   - 实现任务完成后的情绪反馈系统

3. **用户系统**
   - 实现用户注册/登录
   - 实现数据云端存储和同步
   - 实现数据导出/导入功能

### 优先级2：功能扩展

1. **多占卜师系统**
   - 集成ChatGPT API
   - 集成Gemini API
   - 设计不同占卜师的人设和Prompt
   - 实现占卜师选择界面

2. **游戏化系统**
   - 实现连续签到奖励
   - 实现补签功能
   - 实现成就系统

3. **专项占卜扩展**
   - 实现Celtic Cross牌阵（10张）
   - 实现自定义牌阵功能

### 优先级3：优化和扩展

1. **性能优化**
   - API调用优化（缓存、批量请求等）
   - 动画性能优化
   - 数据加载优化

2. **功能扩展**
   - 小组件支持（iOS/Android）
   - TTS语音播报
   - 社交分享功能
   - Avatar系统

3. **商业化准备**
   - 付费系统集成
   - 订阅系统
   - 点数系统
   - 数据分析系统

---

## 📚 相关文档

- [`产品设计.md`](./产品设计.md) - 原始产品设计文档
- [`LLM提示词模板.md`](./LLM提示词模板.md) - Prompt设计详细文档
- [`每日塔罗优化方案.md`](./每日塔罗优化方案.md) - 优化方案文档
- [`关键问题.md`](./关键问题.md) - 关键问题汇总
- [`API配置.md`](./API配置.md) - API配置文档
- [`demo/说明.md`](./demo/说明.md) - Demo版本说明文档

---

## 🔄 文档更新记录

- **2024-XX-XX**：初版文档创建，基于代码实现反向整理
- **2024-XX-XX**：补充技术实现细节和设计决策说明

---

**本文档将持续更新，以反映代码实现的实际情况。**
