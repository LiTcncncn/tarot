# 塔罗模块设计文档

## 📋 功能概述

塔罗模块提供专项塔罗占卜功能，用户可以针对具体问题选择不同牌阵进行深入占卜。

## 🎴 牌阵类型

### 1. 三张牌阵（时间流）
**用途**：了解问题的过去、现在、未来发展
**布局**：一行三张，从左到右
- **位置1**：过去 - 这个问题的起因和过往情况
- **位置2**：现状 - 当前的状态和能量
- **位置3**：未来 - 可能的发展趋势和结果

### 2. 四张牌阵（决策流）
**用途**：分析现状、阻碍、建议和趋势
**布局**：两列两行（2x2网格）
- **位置1（左上）**：现状 - 当前的情况
- **位置2（右上）**：阻碍 - 面临的困难和挑战
- **位置3（左下）**：建议 - 可以采取的行动方向
- **位置4（右下）**：趋势 - 未来的发展方向

### 3. 六张牌阵（关系流）
**用途**：深入分析人际关系（亲密关系、友情、职场关系等）
**布局**：两列三行（2x3网格）
- **位置1（左上）**：我怎么看这段关系 - 我对这段关系的看法和感受
- **位置2（右上）**：对方怎么看 - 对方对这段关系的态度和想法
- **位置3（左中）**：我真正需要的 - 我在这段关系中的真实需求
- **位置4（右中）**：对方真正需要的 - 对方在关系中的真实需求
- **位置5（左下）**：关系的课题：你们卡在哪 - 关系中的核心问题和障碍
- **位置6（右下）**：建议走法：更舒服的相处方式 - 改善关系的具体建议

## 🎨 界面设计

### 页面结构（从顶部到底部）

#### 1. **问题输入区**
- 单行或多行文本输入框
-  placeholder: "请输入你想要占卜的问题...（例如：我该不该换工作？我们的关系会如何发展？）"
- 支持中文输入
- **最大长度限制：200字**（后台限制，不显示字符计数）
- 超过限制时禁用提交按钮或提示

#### 2. **牌阵切换区**
- 显示当前牌阵类型："3张牌阵" / "4张牌阵" / "6张牌阵"
- 三个按钮：`3张` `4张` `6张`
- **切换逻辑**：点击切换牌阵时，自动清空已抽的牌，重新显示空牌位
- 如果有已抽的牌，切换时不提示确认，直接清空（简化流程）

#### 3. **牌阵展示区**
- **空牌位**：
  - 显示位置名称（如"过去"、"现状"等）
  - 浅灰色背景，虚线边框
  - 显示占位符文字："点击牌堆抽取"
- **已抽牌位**：
  - 显示塔罗牌图片
  - 显示牌名和正逆位
  - 逆位牌显示为倒置（180度旋转）
  - 显示位置名称标签

**布局要求**：
- 3张：一行，等宽，响应式适配
- 4张：2x2网格，等宽等高
- 6张：2x3网格，等宽等高

#### 4. **抽牌区**
- **牌堆状态**：
  - 显示牌堆图片（与每日占卜相同）
  - 显示"点击抽牌"提示
  - 点击后依次填充空牌位
  - 每次点击抽取一张，按顺序填充
  - **抽牌规则**：
    - 完全随机（Math.random）
    - **不重复**：同一牌阵中不会重复抽到同一张牌
    - 抽取时播放动画效果
- **占卜按钮**（所有牌位填满后）：
  - 牌堆消失
  - 显示"🔮 开始占卜"按钮
  - 点击后调用AI生成占卜内容
- **每日限制提示**：
  - 如果当天已完成占卜，显示"今日已占卜，明天再来"提示
  - 或显示"今日剩余次数：0次"（为未来扩展预留）

#### 5. **占卜结果显示区**（点击占卜后显示）
- **加载状态**：
  - 显示"正在为你生成专属占卜..."动画
  - 显示已抽取的牌
- **结果内容**：
  - **整体解读**（**总体不超过200字，分为3-4段**）：
    - 根据问题、牌阵和所有牌的综合分析
    - 温柔中肯的语气
    - 包含占卜、疗愈、建议三个维度
    - 段落结构清晰，每段50-70字左右
  - **逐牌解读**（可选，或整合在整体解读中）：
    - 每个位置的牌单独解释
    - 说明这张牌在该位置的含义
    - 结合用户问题和背景信息
  - **行动建议**（整合在整体解读中）：
    - 具体的、可执行的建议
    - 强调温柔治愈和鼓励

#### 6. **补充聊天区**（占卜结果显示后显示）
- **AI占卜师交互**：
  - 固定提示：`Luna`（默认占卜师名称，与每日占卜一致）
  - 头像/标识显示
  - 输入框：`"想深入了解哪个方面？或有其他疑问？"`
  - 快捷问题按钮（可选，第一版可不实现）：
    - "这个牌阵还有什么含义？"
    - "我该注意什么？"
    - "给我一个今天就能做的行动"
    - "为什么我会抽到这些牌？"
- **聊天消息流**：
  - 用户消息：右对齐
  - AI消息：左对齐，显示占卜师标识
  - **聊天轮数限制：2轮**（用户问1次 + AI答1次 = 1轮，共2轮）
  - 达到2轮后，显示提示："今日聊天次数已用完，如需继续深度交流，请等待明天或查看订阅方案"（为未来付费点预留）
- **AI回答依据**：
  - 本次占卜的所有牌和解读
  - 用户输入的原始问题
  - **所有历史**的每日占卜指引、详情、情绪状态、情绪记录（记忆范围：全部）
  - 本次聊天历史（当前对话）
- **记忆逻辑**：
  - 保存本次占卜的所有信息
  - 在后续聊天中引用
  - 聊天记录完整保存到本次占卜记录中

#### 7. **历史占卜结果**（页面最下方）
- **列表展示**：
  - 按时间倒序排列
  - 每个历史记录卡片包含：
    - 问题（摘要，超过一定长度截断，点击展开完整问题）
    - 牌阵类型（3张/4张/6张）
    - 占卜时间
    - 生成的占卜结果（整体解读，默认收起）
    - **聊天记录**（默认收起，显示"共X轮对话"，可点击展开查看）
- **交互**：
  - 点击卡片可展开查看完整详情（问题、占卜结果、逐牌解读）
  - 可以重新查看逐牌解读和所有牌
  - **基于历史占卜继续聊天**：
    - **当天**：可以继续聊天（2轮限制仍然适用）
    - **转天后**：不可以继续聊天，只能查看历史记录
    - 当天可继续聊天时，显示"继续提问"按钮
    - 转天后显示"查看详情"按钮（不可聊天）

## 🔮 AI生成逻辑

### 系统提示词设计

**角色设定**：
```
你是 Luna，一位智慧而温柔的塔罗占卜师。你擅长通过塔罗牌帮助人们进行自我洞察，提供心理投射和情绪支持。你的回答总是温柔、中肯、充满疗愈感，同时给出具体可行的建议。
```

**输入信息**：
1. **本次占卜信息**：
   - 用户输入的问题
   - 选择的牌阵类型
   - 抽取的每张牌（名称、正逆位、位置）

2. **用户背景信息**（**所有历史数据**）：
   - 所有每日占卜的指引（guidance_one_line）
   - 所有每日占卜的详细分析（today_analysis）
   - 所有情绪状态（愉悦/平静/疲惫/迷茫/焦虑）
   - 所有情绪记录（emotionRecord）
   - 注意：数据量可能较大，需要合理组织和筛选最相关的信息

3. **记忆信息**：
   - 本次占卜之前的聊天历史（如果有）
   - 用户之前的问题偏好和关注点

**输出格式（JSON）**：
```json
{
  "overall_reading": "整体解读（总体不超过200字，分为3-4段）...",
  "reading_paragraphs": [
    "第一段（占卜维度）...",
    "第二段（疗愈维度）...",
    "第三段（建议维度）...",
    "第四段（总结或鼓励，可选）..."
  ],
  "card_readings": [
    {
      "position": "过去",
      "card_name": "宝剑皇后",
      "is_reversed": false,
      "interpretation": "这张牌在这个位置的含义（简洁，可整合在整体解读中）..."
    }
    // ... 其他牌
  ]
}
```

**字数要求**：
- 整体解读：**总体不超过200字**
- 分为3-4段，每段50-70字左右
- 使用中文
- 语言风格：温柔、中肯、治愈、鼓励

### 聊天交互逻辑

**上下文记忆**：
- 本次占卜的完整信息
- 用户问题
- **用户所有历史的每日占卜和情绪记录**（全部记忆）
- 当前对话历史（本次占卜内的所有聊天）
- **聊天轮数限制：2轮**（未来作为付费点）

**回答特点**：
- 温柔治愈的语气
- 结合牌阵解读和用户背景
- 提供深入解答和延伸思考
- 避免重复已说内容
- 鼓励和赋能

## 💾 数据存储

### 存储结构

```javascript
{
  "tarot_readings": {
    "2026-01-07_123456": {
      "id": "2026-01-07_123456",
      "timestamp": "2026-01-07T12:34:56.000Z",
      "question": "用户输入的问题",
      "spread_type": "3张" | "4张" | "6张",
      "cards": [
        {
          "position": "过去",
          "card": {
            "id": "swords_queen",
            "name": "Queen of Swords",
            "nameCn": "宝剑皇后",
            "file": "swords_queen.png",
            "reversed": false
          }
        },
        // ... 其他牌
      ],
      "reading": {
        "overall_reading": "整体解读（200字以内，3-4段）",
        "reading_paragraphs": ["段落1", "段落2", "段落3", "段落4"],
        "card_readings": [...]
      },
      "chat_count": 0, // 已使用聊天轮数
      "max_chat_rounds": 2, // 最大聊天轮数
      "can_continue_chat": true, // 是否可以继续聊天（当天可继续，转天不可）
      "chat_history": [
        {
          "role": "user",
          "content": "用户消息",
          "timestamp": "..."
        },
        {
          "role": "assistant",
          "content": "AI回复",
          "timestamp": "..."
        }
      ]
    }
  }
}
```

### localStorage键名
- `tarot_mirror_tarot_readings` - 所有占卜记录
- `tarot_mirror_daily_limit` - 每日占卜限制记录（如：`{"2026-01-07": true}`）

### 每日限制逻辑
- 每天只能进行一次专项占卜
- 使用日期键（YYYY-MM-DD）记录当天是否已占卜
- 午夜后重置
- 占卜成功后立即记录到当日限制

## ✅ 已确认决策

### Q1: 问题输入长度限制
**决策**：200字
**实现**：显示字符计数，超过限制时禁用提交

### Q2: 牌阵切换后的抽牌逻辑
**决策**：清空已抽的牌，重新开始抽
**实现**：切换牌阵时自动清空，无需确认

### Q3: 抽牌随机性
**决策**：完全随机（Math.random）
**实现**：使用 `Math.random()` 抽取，与每日占卜一致

### Q4: 重复抽到同一张牌
**决策**：不可以重复抽到同一张牌
**实现**：同一牌阵中，已抽取的牌从候选池中移除

### Q5: 历史占卜的聊天记录
**决策**：存储，内容收起，可展开显示
**实现**：历史记录中默认收起聊天内容，显示"共X轮对话"，点击展开查看

### Q6: 基于历史占卜继续聊天
**决策**：当天可以，转天不可以
**实现**：检查占卜记录的日期，如果是今天则可以继续聊天（仍需遵守2轮限制），转天后只能查看

### Q7: 记忆范围
**决策**：所有历史数据
**实现**：获取所有历史的每日占卜数据（指引、分析、情绪状态、情绪记录）

### Q8: 占卜次数限制
**决策**：每天一次
**实现**：使用日期键记录每日占卜状态，当天占卜后禁用占卜功能

### Q9: 聊天轮数限制
**决策**：2轮（未来是付费点或订阅点）
**实现**：记录聊天轮数，达到2轮后禁用输入，显示提示信息（为付费点预留接口）

### Q10: 快捷问题按钮
**决策**：第一版暂不实现
**实现**：预留接口，未来可以添加

### Q11: 占卜结果的保存时机
**决策**：生成即保存
**实现**：AI生成占卜结果后立即保存到localStorage

### Q12: 页面导航
**决策**：主导航的塔罗按钮
**实现**：点击底部导航栏的"塔罗"按钮进入独立页面

### Q13: 牌阵布局的响应式
**决策**：保持建议（PC保持原始布局，移动端适配）
**实现**：PC（>=1330px）保持原始布局，移动端（<1330px）根据需要调整（3张一行，4张2x2，6张可能需要单列）

### Q14: AI模型选择
**决策**：暂不明确，先使用DeepSeek API
**实现**：使用与每日占卜相同的DeepSeek API，使用不同的系统提示词

### Q15: 占卜结果的语言
**决策**：中文，分为3-4段，总体不超过200字
**实现**：生成时明确字数限制和段落要求

---

## ❓ 其他待确认问题（可选）

### Q1: 问题输入长度限制
**问题**：问题输入框的最大字符数限制是多少？
**建议**：200字
**选项**：
- A. 200字（简洁明确）
- B. 300字（允许详细描述）
- C. 500字（不限）
- D. 其他：______

### Q2: 牌阵切换后的抽牌逻辑
**问题**：当用户已经抽了几张牌（比如3张牌阵抽了2张），然后切换到4张牌阵，是否应该：
- A. 清空已抽的牌，重新开始抽4张
- B. 保留已抽的牌，在新的牌阵中继续抽（可能会导致混乱）
- C. 提示用户"切换牌阵将清空已抽的牌"，用户确认后再切换

### Q3: 抽牌随机性
**问题**：每次专项占卜的抽牌是否应该是完全随机的？
**建议**：完全随机（与每日占卜一致）
**选项**：
- A. 完全随机（Math.random）
- B. 基于问题内容生成种子（同一问题可能抽到类似牌）
- C. 其他：______

### Q4: 重复抽到同一张牌
**问题**：在同一个牌阵中，是否可以重复抽到同一张牌？
**建议**：可以重复（真实塔罗占卜中可能重复）
**选项**：
- A. 可以重复（真实随机）
- B. 不可以重复（确保牌阵多样性）
- C. 用户可选择：允许重复/不允许重复

### Q5: 历史占卜的聊天记录
**问题**：历史占卜结果中，是否完全隐藏聊天互动，还是可以选择性地显示？
**建议**：完全隐藏（保持历史记录简洁）
**选项**：
- A. 完全隐藏（仅显示问题和占卜结果）
- B. 显示聊天数量（如"共3轮对话"），但内容隐藏
- C. 允许展开查看聊天历史
- D. 其他：______

### Q6: 基于历史占卜继续聊天
**问题**：用户点击历史占卜记录后，是否可以基于那次占卜继续聊天？
**建议**：可以（增强连续性）
**选项**：
- A. 可以，在新的聊天会话中继续（AI记得那次占卜）
- B. 不可以，只能查看历史（保持每次占卜独立）
- C. 重新开始新的占卜（清空之前内容）

### Q7: 记忆范围（近三天数据）
**问题**：AI生成占卜和聊天时，记忆近几天的每日占卜数据？
**建议**：近3天
**选项**：
- A. 近1天（当天）
- B. 近3天（默认）
- C. 近7天（一周）
- D. 近30天（一个月）
- E. 所有历史（全部记忆）

### Q8: 占卜次数限制
**问题**：是否需要限制用户每天或每次的专项占卜次数？
**建议**：第一版不限制
**选项**：
- A. 不限制（自由使用）
- B. 每天限制N次（如3次）
- C. 需要积分/点数（付费机制）
- D. 其他：______

### Q9: 聊天轮数限制
**问题**：每次占卜后的聊天，是否限制轮数？
**建议**：第一版不限制，但可以设置提示
**选项**：
- A. 不限制（自由对话）
- B. 限制N轮（如5轮后提示"已深度交流，建议保存或开始新占卜"）
- C. 其他：______

### Q16: 牌阵布局的移动端优化细节
**问题**：6张牌阵在移动端是否需要改为单列显示？
**选项**：
- A. 保持2x3布局（牌会较小）
- B. 改为单列6行（垂直排列）
- C. 根据屏幕宽度自适应

### Q17: 历史记录的筛选和搜索
**问题**：是否需要支持搜索或筛选历史占卜记录？
**选项**：
- A. 不需要，按时间倒序即可
- B. 需要按问题关键词搜索
- C. 需要按牌阵类型筛选
- D. 未来扩展功能

### Q18: 占卜结果的分享功能
**问题**：是否需要支持分享占卜结果？
**选项**：
- A. 不需要
- B. 需要（文本分享）
- C. 需要（图片分享）
- D. 未来扩展功能

---

## 📝 技术实现要点

### 文件结构
```
demo/
  ├── index.html (添加塔罗页面路由)
  ├── js/
  │   ├── tarot-spread.js (牌阵逻辑：抽牌、布局、状态管理)
  │   ├── tarot-module.js (塔罗模块主逻辑：问题输入、切换牌阵、生成占卜)
  │   ├── tarot-chat.js (聊天交互逻辑)
  │   └── tarot-storage.js (塔罗占卜数据存储)
  └── css/
      └── tarot-module.css (塔罗模块样式)
```

### 关键函数

1. **牌阵管理**：
   - `initSpread(spreadType)` - 初始化牌阵
     - 参数：`"3张" | "4张" | "6张"`
     - 功能：初始化牌阵布局，清空已抽牌状态
   - `drawCardForPosition(position)` - 为指定位置抽牌
     - 参数：位置名称（如"过去"、"现状"等）
     - 功能：从剩余牌池中随机抽取一张（不重复），返回牌数据
     - 实现：维护一个已抽牌ID列表，从全部牌中排除已抽的牌后再随机
   - `switchSpread(newType)` - 切换牌阵类型
     - 参数：新的牌阵类型
     - 功能：清空已抽的牌，重置牌阵布局

2. **占卜生成**：
   - `generateTarotReading(question, spread, cards, userContext)` - 生成占卜内容
     - 参数：问题、牌阵类型、抽到的牌数组、用户上下文（所有历史数据）
     - 功能：调用AI API生成占卜内容（200字以内，3-4段）
   - `buildTarotPrompt(question, spread, cards, context)` - 构建AI提示词
     - 参数：同上
     - 功能：构建包含所有信息的系统提示词和用户提示词
     - 记忆范围：所有历史的每日占卜数据

3. **聊天交互**：
   - `sendChatMessage(message, readingId)` - 发送聊天消息
     - 参数：消息内容、占卜记录ID
     - 功能：检查聊天轮数限制（2轮），发送消息，获取AI回复
     - 限制：达到2轮后禁用输入，显示提示（为付费点预留）
   - `getChatContext(readingId)` - 获取聊天上下文
     - 参数：占卜记录ID
     - 功能：获取本次占卜信息、用户问题、所有历史数据、当前聊天历史
   - `checkChatLimit(readingId)` - 检查聊天轮数
     - 返回：剩余轮数、是否可继续

4. **数据存储**：
   - `saveTarotReading(readingData)` - 保存占卜记录（生成即保存）
     - 功能：占卜结果生成后立即保存到localStorage
   - `getTarotReadings()` - 获取所有历史占卜
     - 返回：按时间倒序排列的所有占卜记录
   - `getAllDailyReadings()` - 获取所有历史的每日占卜数据（全部记忆）
     - 返回：所有历史的每日占卜数据（指引、分析、情绪状态、情绪记录）
   - `checkDailyTarotLimit()` - 检查今天是否可以占卜（每天一次）
     - 返回：boolean，今天是否已占卜
   - `setDailyTarotLimit()` - 设置今日已占卜标记
     - 功能：占卜成功后立即调用，记录当天已占卜
   - `canContinueChat(readingId)` - 检查是否可以继续聊天（当天可，转天不可）
     - 参数：占卜记录ID
     - 功能：检查占卜记录的日期，如果是今天且未达到2轮限制则可继续，转天不可

---

## 🚀 开发优先级

### Phase 1: 基础功能（MVP）
1. ✅ 问题输入区（200字限制，字符计数）
2. ✅ 牌阵切换（3/4/6张，切换时清空已抽牌）
3. ✅ 抽牌功能（点击牌堆依次填充，不重复抽牌）
4. ✅ 每日限制检查（每天一次）
5. ✅ 占卜按钮和生成逻辑（生成即保存）
6. ✅ 占卜结果显示（200字以内，3-4段）

### Phase 2: 交互增强
7. ✅ 补充聊天区（2轮限制）
8. ✅ 历史占卜列表（聊天记录收起，可展开）
9. ✅ 基于历史占卜继续聊天（当天可，转天不可）

### Phase 3: 优化和扩展
10. ⏳ 快捷问题按钮（可选功能）
11. ⏳ 动画效果优化
12. ⏳ 多占卜师系统集成
13. ⏳ 付费点集成（聊天轮数扩展）

### 开发注意事项

1. **不重复抽牌逻辑**：
   - 维护已抽牌ID数组：`drawnCardIds = []`
   - 抽牌时：从全部78张牌中过滤掉已抽的，然后随机选择
   - 切换牌阵时：清空 `drawnCardIds`

2. **每日限制逻辑**：
   - 使用日期键：`{ "2026-01-07": true }`
   - 占卜前检查，占卜后立即标记
   - 午夜后自动重置（基于日期键）

3. **聊天轮数限制**：
   - 每轮 = 用户问1次 + AI答1次
   - 总共2轮 = 最多问2次
   - 达到限制后禁用输入框，显示提示

4. **记忆范围**：
   - 获取所有历史的每日占卜数据
   - 可能需要限制token数量（如果数据量太大）
   - 可以优先选择最近的数据，但应该包含所有数据的关键信息

---

**文档版本**: v2.0  
**最后更新**: 2026-01-07  
**状态**: ✅ 核心问题已确认，可开始开发

