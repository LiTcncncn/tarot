# 镜像句模块实现方案

## 一、需求概述

1. **逻辑选择机制**：根据用户选择的今日状态和"今日指引"（guidance_one_line）匹配合适的逻辑句式（反转句/两难句/边界句/代价句）
2. **预生成内容**：今日占卜后，马上自动根据用户今日状态和"今日指引"预生成问题和选项（包含逻辑类型）
3. **解析生成时机**：用户选择选项后，根据逻辑类型生成对应的解析

## 二、当前实现

### 2.1 数据流
```
generateDailyReadingWithMirror
  ├─ generateTarotReading (生成今日占卜，包含 guidance_one_line)
  └─ generateMirrorQuestionForReading (只生成问题和选项)
      └─ 返回: { question, options }
```

### 2.2 用户交互
```
用户选择选项
  └─ generateMirrorInterpretation (实时生成解析，流式输出)
      └─ 返回: interpretation (字符串)
```

## 三、目标实现

### 3.1 数据流（修改后）
```
generateDailyReadingWithMirror
  ├─ generateTarotReading (生成今日占卜，包含 guidance_one_line)
  └─ generateMirrorQuestionForReading (接收 reading，生成问题、选项和逻辑类型)
      └─ 返回: {
            question: string,
            options: string[],
            logic_type: "反转句" | "两难句" | "边界句" | "代价句"
          }
```

### 3.2 用户交互（修改后）
```
用户选择选项
  └─ generateMirrorInterpretation (根据逻辑类型生成解析，流式输出)
      └─ 返回: interpretation (字符串)
```

## 四、具体实现步骤

### 4.1 修改 `generateMirrorQuestionForReading` 函数

**函数签名：**
```javascript
async function generateMirrorQuestionForReading(userEmotion, tarotCard, moonPhase, reading)
```

**参数说明：**
- `userEmotion`: 用户选择的情绪状态
- `tarotCard`: 今日塔罗牌
- `moonPhase`: 今日月相
- `reading`: 今日占卜结果（包含 `guidance_one_line` 等字段）

**实现要点：**
1. 在 prompt 中包含 `reading.guidance_one_line`，用于逻辑选择
2. 要求 AI 根据用户状态和今日指引选择逻辑类型
3. 生成问题和 3 个选项
4. 返回格式：
   ```json
   {
     "question": "...",
     "options": ["选项A", "选项B", "选项C"],
     "logic_type": "反转句|两难句|边界句|代价句"
   }
   ```

### 4.2 修改 `generateDailyReadingWithMirror` 函数

**修改点：**
- 在调用 `generateMirrorQuestionForReading` 时传入 `reading` 参数
- 保持错误处理逻辑不变

**代码示例：**
```javascript
const mirrorQuestion = await generateMirrorQuestionForReading(
    userEmotion, 
    tarotCard, 
    moonPhase,
    reading  // 新增参数
);
```

### 4.3 修改 `generateMirrorInterpretation` 函数

**修改要点：**
1. 接收 `logic_type` 参数
2. 在 prompt 中包含逻辑类型信息，指导 AI 生成对应类型的解析
3. 保持流式输出（用户体验不变）

**函数签名：**
```javascript
async function generateMirrorInterpretation(question, options, selectedOption, logicType)
```

**代码示例：**
```javascript
const userPrompt = `${context}
【镜像句问题】
问题：${question}
选项：${options.join(', ')}
用户选择：${selectedOption}
逻辑类型：${logicType}

请根据"${logicType}"的逻辑框架，以 Miri 的口吻生成针对用户选择的解读：
- **120 字以内（严格）**
- 共情、温柔、命中，不刻意多说
- 不要使用标题、不要分点、不要带引号
- 直接输出纯文本（不要 JSON / markdown）`;
```

### 4.4 修改 `miri-chat.js` 中的逻辑

**需要修改的函数：**
- 选项点击事件处理（传递 `logic_type` 给 `generateMirrorInterpretation`）

**修改要点：**
1. 从 `state` 中读取 `logic_type`
2. 调用 `generateMirrorInterpretation` 时传入 `logic_type` 参数
3. 保持流式输出的相关代码（用户体验不变）

**代码示例：**
```javascript
// 选项点击事件
btn.addEventListener('click', async () => {
    const optionIndex = parseInt(btn.dataset.optionIndex);
    const selectedOption = options[optionIndex];
    
    // 禁用所有选项按钮
    optionBtns.forEach(b => b.disabled = true);
    
    // 显示用户选择
    appendUserMessage(selectedOption);
    
    // 更新状态
    const state = loadDailyMirrorState() || { question, options };
    state.selectedOption = selectedOption;
    saveDailyMirrorState(state);
    
    // 根据逻辑类型生成解析（流式输出）
    try {
        const interpretation = await generateMirrorInterpretation(
            question, 
            options, 
            selectedOption,
            state.logic_type  // 传入逻辑类型
        );
        const next = loadDailyMirrorState() || state;
        next.interpretation = interpretation;
        saveDailyMirrorState(next);
    } catch (e) {
        // ignore
    } finally {
        generateSuggestions().catch(() => {});
    }
});
```

### 4.5 数据存储结构

**localStorage 存储格式：**
```javascript
{
  question: string,
  options: string[],
  logic_type: string,  // 新增：逻辑类型
  selectedOption: string | null,
  interpretation: string | null
}
```

## 五、API Prompt 设计

### 5.1 系统 Prompt
使用 `MIRI_SYSTEM_PROMPT`（保持不变）

### 5.2 用户 Prompt（需要修改）

**包含内容：**
1. 用户情绪状态
2. 今日塔罗信息
3. 今日月相信息
4. **今日指引（guidance_one_line）**（新增）
5. 任务说明：
   - 根据用户状态和今日指引选择逻辑类型（反转句/两难句/边界句/代价句）
   - 生成镜像句问题（15-25字）
   - 生成 3 个选项（每个 10-15 字）

**输出格式：**
```json
{
  "question": "...",
  "options": ["选项A", "选项B", "选项C"],
  "logic_type": "反转句|两难句|边界句|代价句"
}
```

## 六、兼容性处理

### 6.1 向后兼容
- 如果 `mirrorQuestion` 中没有 `interpretations` 字段（旧数据），fallback 到实时生成
- 或者：要求所有数据都更新（更简单的方案）

### 6.2 错误处理
- 如果镜像句生成失败，返回默认镜像句（包含问题和选项，但不包含逻辑类型）
- 如果解析生成失败，显示错误提示，但不影响已选择的状态

## 七、测试要点

1. **逻辑选择准确性**：验证不同用户状态和今日指引组合下，逻辑类型选择是否合理
2. **解析质量**：验证根据逻辑类型生成的解析是否符合对应逻辑框架的要求（120字以内、共情、温柔）
3. **用户体验**：验证流式输出仍然正常工作，用户体验不受影响
4. **数据一致性**：验证逻辑类型正确传递到解析生成函数

## 八、实施顺序

1. ✅ 完善 MD 文档（已完成）
2. 修改 `generateMirrorQuestionForReading` 函数（接收 reading，生成逻辑类型）
3. 修改 `generateDailyReadingWithMirror` 函数（传入 reading 参数）
4. 修改 `generateMirrorInterpretation` 函数（接收 logic_type 参数）
5. 修改 `miri-chat.js` 中的逻辑（传递 logic_type 给解析函数）
6. 测试验证
7. 同步到 build 目录
